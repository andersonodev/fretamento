name: 📚 Deploy MkDocs to GitHub Pages

on:
  # Executa no push para main
  push:
    branches: 
      - main
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
  
  # Permite execução manual
  workflow_dispatch:

# Define permissões para o GITHUB_TOKEN
permissions:
  contents: read
  pages: write
  id-token: write

# Permite apenas um deploy simultâneo
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job de build e deploy
  deploy:
    name: � Build and Deploy Documentation
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
    
      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 📦 Install MkDocs and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs-material==9.4.8
          pip install mkdocs-mermaid2-plugin==1.1.1
          pip install pymdown-extensions
      
      - name: 📊 Validate MkDocs config
        run: |
          cd docs
          mkdocs --version
          python -c "import yaml; yaml.safe_load(open('mkdocs.yml'))"
      
      - name: 🔨 Build MkDocs site
        run: |
          cd docs
          mkdocs build --verbose --clean
      
      - name: 📋 List generated files
        run: |
          cd docs
          ls -la site/ || echo "Site directory not found"
          if [ -d "site" ]; then
            echo "Total files: $(find site/ -type f | wc -l)"
          fi
      
      - name: � Setup Pages
        uses: actions/configure-pages@v4
        
      - name: � Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/site
          
      - name: � Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4