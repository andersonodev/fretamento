{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Selecionar Ano - Escalas{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/escalas-gerenciar.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid scale-management py-4">
    <div class="page-header mb-4">
        <div class="page-context">
            <h1 class="page-title mb-2">
                <i class="fas fa-calendar-alt text-primary me-2"></i>
                Gerenciar Escalas
            </h1>
            <p class="page-subtitle mb-0">Selecione um ano para continuar.</p>
        </div>
    </div>

    <div class="scale-card shadow-sm border-0 mb-4">
        <div class="card-header border-0 d-flex flex-wrap align-items-center gap-3">
            <h5 class="card-title mb-0">
                <i class="fas fa-plus-circle me-2 text-primary"></i>Criar Nova Escala
            </h5>
        </div>
        <div class="card-body">
            <form method="post" id="formCriarEstruturaAno" class="row g-3 align-items-end" action="{% url 'escalas:selecionar_ano' %}">
                {% csrf_token %}
                <input type="hidden" name="acao" value="criar_estrutura">
                <div class="col-md-5 col-lg-4">
                    <label for="data" class="form-label">Data da Escala</label>
                    <div class="input-group">
                        <input type="date" class="form-control" name="data" id="data" required lang="pt-BR">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Criar Estrutura
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if anos %}
        <div class="overview-carousel" data-carousel="anos">
            <button type="button" class="overview-carousel__nav prev" data-carousel-prev aria-label="Mostrar anos anteriores">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="overview-carousel__viewport">
                <div class="overview-carousel__track" data-carousel-track>
                    {% for ano_info in anos %}
                        <a href="{% url 'escalas:selecionar_mes_ano' ano=ano_info.ano %}" class="overview-card {% if ano_info.eh_atual %}is-current{% endif %} {% if ano_info.total_escalas == 0 %}is-empty{% endif %}">
                            <div class="overview-card__eyebrow">
                                {% if ano_info.eh_atual %}
                                    Ano atual
                                {% elif ano_info.total_escalas > 0 %}
                                    {{ ano_info.total_escalas }} escala{% if ano_info.total_escalas != 1 %}s{% endif %}
                                {% else %}
                                    Sem escalas
                                {% endif %}
                            </div>
                            <div class="overview-card__body">
                                <h2 class="overview-card__title">{{ ano_info.ano }}</h2>
                                {% if ano_info.meses_com_escalas > 0 %}
                                    <p class="overview-card__subtitle">{{ ano_info.meses_com_escalas }} mês{% if ano_info.meses_com_escalas != 1 %}es{% endif %} com escalas</p>
                                {% else %}
                                    <p class="overview-card__subtitle text-muted">Nenhum mês com escalas registradas</p>
                                {% endif %}

                                <div class="overview-card__chips">
                                    {% if ano_info.escalas_aprovadas > 0 %}
                                        <span class="status-chip success"><i class="fas fa-check"></i>{{ ano_info.escalas_aprovadas }}</span>
                                    {% endif %}
                                    {% if ano_info.escalas_pendentes > 0 %}
                                        <span class="status-chip warning"><i class="fas fa-clock"></i>{{ ano_info.escalas_pendentes }}</span>
                                    {% endif %}
                                    {% if ano_info.escalas_rejeitadas > 0 %}
                                        <span class="status-chip danger"><i class="fas fa-times"></i>{{ ano_info.escalas_rejeitadas }}</span>
                                    {% endif %}
                                </div>

                                <dl class="metric-list">
                                    <div class="metric">
                                        <dt>Escalas</dt>
                                        <dd>{{ ano_info.total_escalas }}</dd>
                                    </div>
                                    <div class="metric">
                                        <dt>Serviços</dt>
                                        <dd>{{ ano_info.total_servicos }}</dd>
                                    </div>
                                    {% if ano_info.total_valor > 0 %}
                                        <div class="metric">
                                            <dt>Valor total</dt>
                                            <dd>{{ ano_info.total_valor|currency_no_cents }}</dd>
                                        </div>
                                    {% endif %}
                                </dl>
                            </div>
                            <span class="overview-card__cta">Ver meses <i class="fas fa-arrow-right"></i></span>
                        </a>
                    {% endfor %}
                </div>
            </div>
            <button type="button" class="overview-carousel__nav next" data-carousel-next aria-label="Mostrar anos seguintes">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    {% else %}
        <div class="overview-empty">
            <div class="overview-empty__icon">
                <i class="fas fa-calendar-minus"></i>
            </div>
            <h6 class="overview-empty__title">Nenhum ano disponível</h6>
            <p class="overview-empty__text">Crie uma nova estrutura de escala para começar a acompanhar os resultados por ano.</p>
        </div>
    {% endif %}

    <div class="info-panel mt-5">
        <div class="info-panel__icon">
            <i class="fas fa-lightbulb"></i>
        </div>
        <div class="info-panel__content">
            <h6>Como usar</h6>
            <div class="info-panel__grid">
                <p><strong>Selecione o ano</strong> para visualizar os meses disponíveis e acompanhar o status das escalas.</p>
                <p><strong>Acompanhe as estatísticas</strong> para entender rapidamente volume, pendências e valores movimentados no período.</p>
                <p><strong>Crie novas estruturas</strong> quando precisar iniciar um planejamento de escala para uma data específica.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('[data-carousel]').forEach(function (carousel) {
                const track = carousel.querySelector('[data-carousel-track]');
                if (!track) {
                    return;
                }

                const prevButton = carousel.querySelector('[data-carousel-prev]');
                const nextButton = carousel.querySelector('[data-carousel-next]');

                const getGapValue = function () {
                    const styles = window.getComputedStyle(track);
                    const gapValue = styles.columnGap || styles.gap || '0';
                    const parsed = parseFloat(gapValue);
                    return isNaN(parsed) ? 0 : parsed;
                };

                const getScrollAmount = function () {
                    const firstCard = track.querySelector('.overview-card');
                    if (!firstCard) {
                        return track.clientWidth || 240;
                    }
                    return firstCard.getBoundingClientRect().width + getGapValue();
                };

                const updateButtons = function () {
                    const maxScrollLeft = Math.max(track.scrollWidth - track.clientWidth - 1, 0);
                    if (prevButton) {
                        prevButton.disabled = track.scrollLeft <= 1;
                        prevButton.classList.toggle('is-edge', prevButton.disabled);
                    }
                    if (nextButton) {
                        nextButton.disabled = track.scrollLeft >= maxScrollLeft;
                        nextButton.classList.toggle('is-edge', nextButton.disabled);
                    }
                    carousel.classList.toggle('is-scrollable', track.scrollWidth > track.clientWidth + 1);
                };

                const scrollByAmount = function (direction) {
                    const amount = getScrollAmount() * direction;
                    track.scrollBy({ left: amount, behavior: 'smooth' });
                };

                if (prevButton) {
                    prevButton.addEventListener('click', function () {
                        scrollByAmount(-1);
                    });
                }

                if (nextButton) {
                    nextButton.addEventListener('click', function () {
                        scrollByAmount(1);
                    });
                }

                track.addEventListener('scroll', updateButtons, { passive: true });
                window.addEventListener('resize', updateButtons);

                updateButtons();
            });
        });
    </script>
{% endblock %}
