{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Visualizar Escala - {{ escala.data|date:"d/m/Y" }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0">
                        <i class="fas fa-calendar-check text-primary"></i>
                        Escala - {{ escala.data|date:"l, d/m/Y" }}
                    </h1>
                    <p class="text-muted">
                        Status: <span class="badge bg-{% if escala.etapa == 'ESTRUTURA' %}secondary{% elif escala.etapa == 'DADOS_PUXADOS' %}primary{% else %}success{% endif %}">{{ escala.get_etapa_display }}</span>
                        {% if escala.data_origem %}
                            | Dados de: {{ escala.data_origem|date:"d/m/Y" }}
                        {% endif %}
                    </p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{% url 'escalas:gerenciar_escalas_mes' mes=mes ano=ano %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    {% if escala.tem_dados %}
                        <a href="{% url 'escalas:exportar_escala' data=escala.data|date_br %}" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                    {% endif %}
                    {% if escala.tem_dados %}
                        <button type="button" class="btn btn-primary" id="btn-precificar" onclick="precificarEscala()">
                            <span class="spinner-border spinner-border-sm me-2 d-none button-spinner" role="status" aria-hidden="true"></span>
                            <i class="fas fa-calculator button-icon"></i>
                            <span class="button-text ms-1">Precificar</span>
                        </button>
                        <form method="post" class="d-inline" id="form-agrupar">
                            {% csrf_token %}
                            <button type="submit" name="acao" value="agrupar" class="btn btn-info" id="btn-agrupar">
                                <span class="spinner-border spinner-border-sm me-2 d-none button-spinner" role="status" aria-hidden="true"></span>
                                <i class="fas fa-layer-group button-icon"></i>
                                <span class="button-text ms-1">Agrupar</span>
                            </button>
                        </form>
                        <form method="post" class="d-inline" id="form-escalar">
                            {% csrf_token %}
                            <button type="submit" name="acao" value="otimizar" class="btn btn-warning" id="btn-escalar">
                                <span class="spinner-border spinner-border-sm me-2 d-none button-spinner" role="status" aria-hidden="true"></span>
                                <i class="fas fa-magic button-icon"></i>
                                <span class="button-text ms-1">Escalar</span>
                            </button>
                        </form>
                        <!-- Permitir formatação sempre que a escala tiver dados -->
                        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modal-formatar">
                            <i class="fas fa-paint-brush"></i> 
                            {% if escala.etapa == 'OTIMIZADA' %}
                                Formatar
                            {% else %}
                                Limpar/Formatar
                            {% endif %}
                        </button>
                        
                        <!-- Botão para adicionar serviço manual -->
                        <button type="button" class="btn btn-success" onclick="abrirModalAdicionarServico()" title="Adicionar serviço manualmente">
                            <i class="fas fa-plus-circle"></i> Adicionar Serviço
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if not escala.tem_dados %}
        <!-- Estrutura Criada - Instruções -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> Estrutura Criada com Sucesso!</h5>
                    <p class="mb-2">A estrutura básica da escala foi criada. Agora você pode:</p>
                    <a href="{% url 'escalas:puxar_dados' data=escala.data|date_br %}" class="btn btn-primary">
                        <i class="fas fa-download"></i> Puxar Dados de uma Data
                    </a>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Instruções Kanban -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <h6><i class="fas fa-info-circle"></i> Sistema Kanban Avançado</h6>
                    <ul class="mb-0 small">
                        <li><strong>Mover entre vans:</strong> Arraste um serviço para o espaço vazio da outra van</li>
                        <li><strong>Agrupar serviços:</strong> Arraste um serviço e solte BEM NO CENTRO de outro cartão</li>
                        <li><strong>Indicadores visuais:</strong> Verde = Agrupar | Azul = Mover para van</li>
                        <li><strong>Desagrupar individual:</strong> Duplo clique no cartão OU clique no botão <i class="fas fa-unlink text-danger"></i></li>
                        <li><strong>Desagrupar completo:</strong> Clique direito no cartão → "Desagrupar grupo completo"</li>
                        <li><strong>Menu de contexto:</strong> Clique direito em qualquer cartão para mais opções</li>
                        <li><strong>Filtrar:</strong> Use os filtros acima para encontrar serviços específicos</li>
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>

        <!-- Resumo Geral -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-users"></i> Total PAX
                        </h5>
                        <h3>{{ van1.total_pax|add:van2.total_pax }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-dollar-sign"></i> Valor Total
                        </h5>
                        <h3>{{ van1.total_valor|add:van2.total_valor|currency }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-layer-group"></i> Total Serviços
                        </h5>
                        <h3>{{ total_servicos }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white {% if escala.esta_otimizada %}bg-success{% else %}bg-warning{% endif %}">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-magic"></i> Status
                        </h5>
                        <h6>{% if escala.esta_otimizada %}Otimizada{% else %}Distribuição Básica{% endif %}</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-light">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-filter text-info"></i> Filtros de Busca
                            <button class="btn btn-sm btn-outline-secondary ms-2" id="clearFilters">
                                <i class="fas fa-times"></i> Limpar
                            </button>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Filtro por PAX -->
                            <div class="col-md-3">
                                <label for="filtro-pax" class="form-label small">
                                    <i class="fas fa-users text-primary"></i> PAX
                                </label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="filtro-pax-min" placeholder="Min" min="1">
                                    <span class="input-group-text">até</span>
                                    <input type="number" class="form-control" id="filtro-pax-max" placeholder="Max" min="1">
                                </div>
                            </div>
                            
                            <!-- Filtro por Serviço -->
                            <div class="col-md-4">
                                <label for="filtro-servico" class="form-label small">
                                    <i class="fas fa-map-marker-alt text-danger"></i> Serviço/Destino
                                </label>
                                <input type="text" class="form-control form-control-sm" id="filtro-servico" 
                                       placeholder="Digite para filtrar por serviço...">
                            </div>
                            
                            <!-- Filtro por Local Pickup -->
                            <div class="col-md-3">
                                <label for="filtro-pickup" class="form-label small">
                                    <i class="fas fa-location-dot text-warning"></i> Local Pickup
                                </label>
                                <input type="text" class="form-control form-control-sm" id="filtro-pickup" 
                                       placeholder="Digite para filtrar pickup...">
                            </div>
                            
                            <!-- Filtro por Van -->
                            <div class="col-md-2">
                                <label for="filtro-van" class="form-label small">
                                    <i class="fas fa-van-shuttle text-info"></i> Van
                                </label>
                                <select class="form-select form-select-sm" id="filtro-van">
                                    <option value="">Todas</option>
                                    <option value="VAN1">Van 1</option>
                                    <option value="VAN2">Van 2</option>
                                </select>
                            </div>
                            
                            <!-- Filtro por Status -->
                            {% if escala.esta_otimizada %}
                            <div class="col-md-2">
                                <label for="filtro-status" class="form-label small">
                                    <i class="fas fa-check-circle text-success"></i> Status
                                </label>
                                <select class="form-select form-select-sm" id="filtro-status">
                                    <option value="">Todos</option>
                                    <option value="ALOCADO">Alocados</option>
                                    <option value="NAO_ALOCADO">Não alocados</option>
                                </select>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Estatísticas de Filtro -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted" id="filtro-stats">
                                        Mostrando todos os serviços
                                    </small>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="filtro-pax-alto" title="PAX Acima de 4 (Clique novamente para remover filtro)">
                                            <i class="fas fa-users"></i> PAX 4+
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="filtro-pax-baixo" title="PAX de 1 a 3 (Clique novamente para remover filtro)">
                                            <i class="fas fa-user"></i> PAX 1-3
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="filtro-hotelbeds" title="HOTELBEDS (Clique novamente para remover filtro)">
                                            <i class="fas fa-hotel"></i> HOTELBEDS
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="filtro-holiday" title="Holiday (Clique novamente para remover filtro)">
                                            <i class="fas fa-plane"></i> Holiday
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" id="filtro-transfer-in" title="Transfer IN (Clique novamente para remover filtro)">
                                            <i class="fas fa-arrow-right"></i> IN
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" id="filtro-transfer-out" title="Transfer OUT (Clique novamente para remover filtro)">
                                            <i class="fas fa-arrow-left"></i> OUT
                                        </button>
                                        <button type="button" class="btn btn-outline-dark" id="filtro-barra" title="Barra da Tijuca (Clique novamente para remover filtro)">
                                            <i class="fas fa-map-marker-alt"></i> Barra
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" id="filtro-prioritarios" title="Serviços Prioritários (4-10 PAX + Hotelbeds/Holiday/Barra) (Clique novamente para remover filtro)">
                                            <i class="fas fa-star"></i> Prioritários
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="filtro-alocados" title="Serviços Alocados (Clique novamente para remover filtro)">
                                            <i class="fas fa-check"></i> Alocados
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" id="filtro-nao-alocados" title="Serviços Não Alocados (Clique novamente para remover filtro)">
                                            <i class="fas fa-times"></i> Não Alocados
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informações sobre Grupos (se existirem) -->
        {% if grupos_van1 or grupos_van2 %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-layer-group text-success"></i> 
                            Grupos de Serviços
                            <small class="text-muted">({{ grupos_van1.count|add:grupos_van2.count }} grupos ativos)</small>
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row">
                            {% if grupos_van1 %}
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-2">Van 1</h6>
                                    {% for grupo in grupos_van1 %}
                                        <div class="card mb-2 border-success">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <strong>Grupo #{{ grupo|grupo_sequencial:grupos_van1 }}</strong>
                                                        <small class="d-block text-muted">{{ grupo.cliente_principal }}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-success">{{ grupo.servicos.count }} serviços</span>
                                                        <small class="d-block text-muted">{{ grupo.total_pax }} PAX</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if grupos_van2 %}
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-2">Van 2</h6>
                                    {% for grupo in grupos_van2 %}
                                        <div class="card mb-2 border-success">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <strong>Grupo #{{ grupo|grupo_sequencial:grupos_van2 }}</strong>
                                                        <small class="d-block text-muted">{{ grupo.cliente_principal }}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-success">{{ grupo.servicos.count }} serviços</span>
                                                        <small class="d-block text-muted">{{ grupo.total_pax }} PAX</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Interface Kanban - Van 1 e Van 2 -->
        <div class="row" id="kanban-container">
            <!-- Van 1 -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-van-shuttle"></i> Van 1
                                <span class="badge bg-light text-dark ms-2" id="van1-pax">{{ van1.total_pax }} PAX</span>
                                <span class="badge bg-light text-dark ms-1" id="van1-valor">{{ van1.total_valor|currency }}</span>
                                <span class="badge bg-light text-dark ms-1" id="van1-servicos">{{ van1.count }} serviços</span>
                            </div>
                            <div>
                                {% if escala.tem_dados %}
                                    <button type="button" 
                                            class="btn btn-success btn-sm" 
                                            onclick="exportarVanParaExcel('VAN1')" 
                                            title="Exportar Van 1 para Excel">
                                        <i class="fas fa-file-excel"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </h5>
                    </div>
                    <div class="card-body p-2" id="van1-container" data-van="VAN1">
                        {% for alocacao in van1.servicos %}
                            <div class="servico-card" 
                                 data-alocacao-id="{{ alocacao.id }}" 
                                 data-servico-id="{{ alocacao.servico.id }}"
                                 data-pax="{{ alocacao.servico.pax }}"
                                 data-valor="{{ alocacao.grupo_info.grupo.total_valor|default:alocacao.preco_calculado|default:0 }}"
                                 data-servico="{{ alocacao.servico.servico|lower }}"
                                 data-pickup="{{ alocacao.servico.local_pickup|lower|default:'' }}"
                                 data-cliente="{{ alocacao.servico.cliente|lower }}"
                                 data-van="VAN1"
                                 data-status="{{ alocacao.status_alocacao }}">
                                <div class="card mb-2 border {% if alocacao.grupo_info %}border-success{% endif %}" {% if alocacao.grupo_info %}title="Duplo clique para desagrupar | Clique direito para mais opções"{% endif %}>
                                    {% if alocacao.grupo_info %}
                                        <div class="card-header p-1 bg-light">
                                            <small class="text-success">
                                                <i class="fas fa-layer-group"></i> 
                                                Grupo #{{ alocacao.grupo_info.grupo|grupo_sequencial:grupos_van1 }} 
                                                ({{ alocacao.grupo_info.grupo.servicos.count }} serviços){% if alocacao.grupo_info.grupo.get_vendas_unicas %}<br><i class="fas fa-hashtag"></i> {{ alocacao.grupo_info.grupo.get_vendas_unicas }}{% endif %}
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm float-end py-0 px-1"
                                                        onclick="desagruparServico({{ alocacao.id }})"
                                                        title="Remover do grupo">
                                                    <i class="fas fa-unlink"></i>
                                                </button>
                                            </small>
                                        </div>
                                    {% endif %}
                                    <div class="card-body p-3">
                                        <!-- Cabeçalho do Serviço -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">
                                                    {% if alocacao.grupo_info %}
                                                        {{ alocacao.grupo_info.grupo.get_clientes_concatenados }}
                                                    {% else %}
                                                        {{ alocacao.servico.cliente }}
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-hashtag"></i> {{ alocacao.servico.numero_da_compra|default:"-" }}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                {% if alocacao.grupo_info %}
                                                    <span class="badge bg-primary">{{ alocacao.grupo_info.grupo.total_pax }} PAX</span>
                                                    <br><span class="badge bg-success">{{ alocacao.grupo_info.grupo.total_valor|currency }}</span>
                                                    <i class="fas fa-edit text-warning ms-1" style="cursor: pointer;" 
                                                       onclick="event.stopPropagation(); abrirModalTarifarios('{{ alocacao.servico.id }}', 'grupo', '{{ alocacao.grupo_info.grupo.id }}')"
                                                       title="Editar preço"></i>
                                                {% else %}
                                                    <span class="badge bg-primary">{{ alocacao.servico.pax }} PAX</span>
                                                    {% if alocacao.preco_calculado is not None %}
                                                        <br><span class="badge bg-success">{{ alocacao.preco_calculado|currency }}</span>
                                                        <i class="fas fa-edit text-warning ms-1" style="cursor: pointer;" 
                                                           onclick="event.stopPropagation(); abrirModalTarifarios('{{ alocacao.servico.id }}', 'individual')"
                                                           title="Editar preço"></i>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Detalhes do Serviço -->
                                        <div class="small">
                                            <div class="mb-1">
                                                <i class="fas fa-map-marker-alt text-danger"></i>
                                                <strong>Serviço:</strong> {{ alocacao.servico.servico }}
                                            </div>
                                            
                                            {% if alocacao.grupo_info %}
                                                <!-- Mostrar informações consolidadas do grupo -->
                                                {% if alocacao.grupo_info.grupo.get_pickups_concatenados %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-location-dot text-warning"></i>
                                                        <strong>Pickup:</strong> {{ alocacao.grupo_info.grupo.get_pickups_concatenados }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="row g-1">
                                                    {% if alocacao.grupo_info.grupo.get_horarios_concatenados %}
                                                        <div class="col-6">
                                                            <i class="fas fa-clock text-info"></i>
                                                            {{ alocacao.grupo_info.grupo.get_horarios_concatenados }}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if alocacao.grupo_info.grupo.get_vendas_unicas %}
                                                        <div class="col-6">
                                                            <i class="fas fa-shopping-cart text-success"></i>
                                                            Vendas: {{ alocacao.grupo_info.grupo.get_vendas_unicas }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <!-- Mostrar informações individuais -->
                                                {% if alocacao.servico.local_pickup %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-location-dot text-warning"></i>
                                                        <strong>Pickup:</strong> {{ alocacao.servico.local_pickup }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="row g-1">
                                                    <div class="col-6">
                                                        <i class="fas fa-clock text-info"></i>
                                                        {% if alocacao.servico.horario %}
                                                            {{ alocacao.servico.horario|time:"H:i" }}
                                                        {% else %}
                                                            <span class="text-warning">SEM HORARIO</span>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if alocacao.servico.numero_venda %}
                                                        <div class="col-6">
                                                            <i class="fas fa-shopping-cart text-success"></i>
                                                            Vendas: {{ alocacao.servico.numero_venda }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                            
                                            <div class="mt-1 d-flex justify-content-between align-items-center flex-wrap gap-1">
                                                <div class="d-flex flex-wrap align-items-center gap-1">
                                                    {% if alocacao.veiculo_recomendado %}
                                                        <span class="badge bg-secondary">{{ alocacao.veiculo_recomendado }}</span>
                                                    {% endif %}
                                                    {% if alocacao.automatica %}
                                                        <span class="badge bg-info">Auto</span>
                                                    {% else %}
                                                        <span class="badge bg-dark">Manual</span>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    {% if alocacao.status_alocacao == 'ALOCADO' %}
                                                        <span class="badge bg-success px-3 py-2 text-uppercase fw-semibold status-badge clickable-status" 
                                                              data-alocacao-id="{{ alocacao.id }}" 
                                                              data-status-atual="ALOCADO" 
                                                              style="cursor: pointer;" 
                                                              title="Clique para mudar para NÃO ALOCADO">Alocado</span>
                                                    {% else %}
                                                        <span class="badge bg-danger px-3 py-2 text-uppercase fw-semibold status-badge clickable-status" 
                                                              data-alocacao-id="{{ alocacao.id }}" 
                                                              data-status-atual="NAO_ALOCADO" 
                                                              style="cursor: pointer;" 
                                                              title="Clique para mudar para ALOCADO">Não alocado</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center py-4 dropzone" data-van="VAN1">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">Van vazia</h6>
                                <p class="text-muted small">Arraste serviços aqui</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Van 2 -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-van-shuttle"></i> Van 2
                                <span class="badge bg-light text-dark ms-2" id="van2-pax">{{ van2.total_pax }} PAX</span>
                                <span class="badge bg-light text-dark ms-1" id="van2-valor">{{ van2.total_valor|currency }}</span>
                                <span class="badge bg-light text-dark ms-1" id="van2-servicos">{{ van2.count }} serviços</span>
                            </div>
                            <div>
                                {% if escala.tem_dados %}
                                    <button type="button" 
                                            class="btn btn-success btn-sm" 
                                            onclick="exportarVanParaExcel('VAN2')" 
                                            title="Exportar Van 2 para Excel">
                                        <i class="fas fa-file-excel"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </h5>
                    </div>
                    <div class="card-body p-2" id="van2-container" data-van="VAN2">
                        {% for alocacao in van2.servicos %}
                            <div class="servico-card" 
                                 data-alocacao-id="{{ alocacao.id }}" 
                                 data-servico-id="{{ alocacao.servico.id }}"
                                 data-pax="{{ alocacao.servico.pax }}"
                                 data-valor="{{ alocacao.grupo_info.grupo.total_valor|default:alocacao.preco_calculado|default:0 }}"
                                 data-servico="{{ alocacao.servico.servico|lower }}"
                                 data-pickup="{{ alocacao.servico.local_pickup|lower|default:'' }}"
                                 data-cliente="{{ alocacao.servico.cliente|lower }}"
                                 data-van="VAN2"
                                 data-status="{{ alocacao.status_alocacao }}">
                                <div class="card mb-2 border {% if alocacao.grupo_info %}border-success{% endif %}" {% if alocacao.grupo_info %}title="Duplo clique para desagrupar | Clique direito para mais opções"{% endif %}>
                                    {% if alocacao.grupo_info %}
                                        <div class="card-header p-1 bg-light">
                                            <small class="text-success">
                                                <i class="fas fa-layer-group"></i> 
                                                Grupo #{{ alocacao.grupo_info.grupo|grupo_sequencial:grupos_van2 }} 
                                                ({{ alocacao.grupo_info.grupo.servicos.count }} serviços){% if alocacao.grupo_info.grupo.get_vendas_unicas %}<br><i class="fas fa-hashtag"></i> {{ alocacao.grupo_info.grupo.get_vendas_unicas }}{% endif %}
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm float-end py-0 px-1"
                                                        onclick="desagruparServico({{ alocacao.id }})"
                                                        title="Remover do grupo">
                                                    <i class="fas fa-unlink"></i>
                                                </button>
                                            </small>
                                        </div>
                                    {% endif %}
                                    <div class="card-body p-3">
                                        <!-- Cabeçalho do Serviço -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">
                                                    {% if alocacao.grupo_info %}
                                                        {{ alocacao.grupo_info.grupo.get_clientes_concatenados }}
                                                    {% else %}
                                                        {{ alocacao.servico.cliente }}
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-hashtag"></i> {{ alocacao.servico.numero_da_compra|default:"-" }}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                {% if alocacao.grupo_info %}
                                                    <span class="badge bg-primary">{{ alocacao.grupo_info.grupo.total_pax }} PAX</span>
                                                    <br><span class="badge bg-success">{{ alocacao.grupo_info.grupo.total_valor|currency }}</span>
                                                    <i class="fas fa-edit text-warning ms-1" style="cursor: pointer;" 
                                                       onclick="event.stopPropagation(); abrirModalTarifarios('{{ alocacao.servico.id }}', 'grupo', '{{ alocacao.grupo_info.grupo.id }}')"
                                                       title="Editar preço"></i>
                                                {% else %}
                                                    <span class="badge bg-primary">{{ alocacao.servico.pax }} PAX</span>
                                                    {% if alocacao.preco_calculado is not None %}
                                                        <br><span class="badge bg-success">{{ alocacao.preco_calculado|currency }}</span>
                                                        <i class="fas fa-edit text-warning ms-1" style="cursor: pointer;" 
                                                           onclick="event.stopPropagation(); abrirModalTarifarios('{{ alocacao.servico.id }}', 'individual')"
                                                           title="Editar preço"></i>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Detalhes do Serviço -->
                                        <div class="small">
                                            <div class="mb-1">
                                                <i class="fas fa-map-marker-alt text-danger"></i>
                                                <strong>Serviço:</strong> {{ alocacao.servico.servico }}
                                            </div>
                                            
                                            {% if alocacao.grupo_info %}
                                                <!-- Mostrar informações consolidadas do grupo -->
                                                {% if alocacao.grupo_info.grupo.get_pickups_concatenados %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-location-dot text-warning"></i>
                                                        <strong>Pickup:</strong> {{ alocacao.grupo_info.grupo.get_pickups_concatenados }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="row g-1">
                                                    {% if alocacao.grupo_info.grupo.get_horarios_concatenados %}
                                                        <div class="col-6">
                                                            <i class="fas fa-clock text-info"></i>
                                                            {{ alocacao.grupo_info.grupo.get_horarios_concatenados }}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if alocacao.grupo_info.grupo.get_vendas_unicas %}
                                                        <div class="col-6">
                                                            <i class="fas fa-shopping-cart text-success"></i>
                                                            Vendas: {{ alocacao.grupo_info.grupo.get_vendas_unicas }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <!-- Mostrar informações individuais -->
                                                {% if alocacao.servico.local_pickup %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-location-dot text-warning"></i>
                                                        <strong>Pickup:</strong> {{ alocacao.servico.local_pickup }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="row g-1">
                                                    <div class="col-6">
                                                        <i class="fas fa-clock text-info"></i>
                                                        {% if alocacao.servico.horario %}
                                                            {{ alocacao.servico.horario|time:"H:i" }}
                                                        {% else %}
                                                            <span class="text-warning">SEM HORARIO</span>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if alocacao.servico.numero_venda %}
                                                        <div class="col-6">
                                                            <i class="fas fa-shopping-cart text-success"></i>
                                                            Vendas: {{ alocacao.servico.numero_venda }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                            
                                            <div class="mt-1 d-flex justify-content-between align-items-center flex-wrap gap-1">
                                                <div class="d-flex flex-wrap align-items-center gap-1">
                                                    {% if alocacao.veiculo_recomendado %}
                                                        <span class="badge bg-secondary">{{ alocacao.veiculo_recomendado }}</span>
                                                    {% endif %}
                                                    {% if alocacao.automatica %}
                                                        <span class="badge bg-info">Auto</span>
                                                    {% else %}
                                                        <span class="badge bg-dark">Manual</span>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    {% if alocacao.status_alocacao == 'ALOCADO' %}
                                                        <span class="badge bg-success px-3 py-2 text-uppercase fw-semibold status-badge clickable-status" 
                                                              data-alocacao-id="{{ alocacao.id }}" 
                                                              data-status-atual="ALOCADO" 
                                                              style="cursor: pointer;" 
                                                              title="Clique para mudar para NÃO ALOCADO">Alocado</span>
                                                    {% else %}
                                                        <span class="badge bg-danger px-3 py-2 text-uppercase fw-semibold status-badge clickable-status" 
                                                              data-alocacao-id="{{ alocacao.id }}" 
                                                              data-status-atual="NAO_ALOCADO" 
                                                              style="cursor: pointer;" 
                                                              title="Clique para mudar para ALOCADO">Não alocado</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center py-4 dropzone" data-van="VAN2">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">Van vazia</h6>
                                <p class="text-muted small">Arraste serviços aqui</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Ações -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex gap-2 justify-content-center flex-wrap">
                    <a href="{% url 'escalas:gerenciar_escalas' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar ao Gerenciamento
                    </a>

                    
                    {% if escala.tem_dados %}
                        <a href="{% url 'escalas:exportar_escala' data=escala.data|date_br %}" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Exportar para Excel
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- CSS para drag and drop -->
<style>
.servico-card {
    cursor: default;
    transition: all 0.3s ease;
}

.servico-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.servico-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.servico-card.drop-target {
    border: 3px solid #28a745;
    background-color: rgba(40, 167, 69, 0.1);
    transform: scale(1.02);
}

.servico-card.drop-target::before {
    content: "🔗 AGRUPAR";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    z-index: 10;
    pointer-events: none;
}

.van-container.drag-over {
    border: 3px solid #007bff;
    background-color: rgba(0, 123, 255, 0.1);
}

.van-container.drag-over::before {
    content: "📦 MOVER PARA ESTA VAN";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #007bff;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    z-index: 10;
    pointer-events: none;
}

.dropzone {
    min-height: 100px;
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
}

.dropzone.drag-over {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.1);
}

#van1-container, #van2-container {
    min-height: 200px;
    position: relative;
}

.van-container {
    min-height: 400px;
    position: relative;
}

/* === ESTILOS PARA FILTROS === */
.btn.active {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}

.btn-outline-warning.active {
    background-color: var(--bs-warning);
    border-color: var(--bs-warning);
    color: var(--bs-dark);
}

.btn-outline-info.active {
    background-color: var(--bs-info);
    border-color: var(--bs-info);
    color: white;
}

.servico-card[style*="display: none"] {
    transition: opacity 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
}

#filtro-stats strong {
    color: var(--bs-primary);
}

/* Animação suave para filtros */
.servico-card {
    transition: all 0.3s ease;
}

/* Estilos para menu de contexto */
.menu-item {
    padding: 8px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.menu-item:hover {
    background-color: #f8f9fa;
}

.menu-item:last-child {
    border-bottom: none;
}

.menu-item.disabled {
    color: #6c757d;
    cursor: not-allowed;
}

.menu-item.disabled:hover {
    background-color: transparent;
}

.menu-item-hint {
    padding: 5px 15px;
    font-size: 11px;
    color: #6c757d;
    font-style: italic;
    background-color: #f8f9fa;
}

/* Melhorar indicação visual de grupos */
.servico-card .border-success {
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
}

.servico-card:hover .border-success {
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.4);
}

/* Tooltip para duplo clique */
.servico-card[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 5px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
}

/* === ESTILOS PARA BOTÕES DE LOADING === */
.btn.loading {
    opacity: 0.8;
    cursor: not-allowed;
    position: relative;
}

.btn.loading:hover {
    transform: none !important;
}

.button-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<!-- JavaScript para funcionalidade Kanban -->
<script>
// Função global para mostrar mensagens
function showMessage(text, type) {
    // Remover mensagem anterior se existir
    const existingAlert = document.querySelector('.alert-message');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show alert-message" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            ${text}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto-remover após 3 segundos
    setTimeout(() => {
        const alert = document.querySelector('.alert-message');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}

// Função para controlar o estado de loading dos botões
function setButtonLoading(button, isLoading, customText = null) {
    if (!button) return;
    
    const spinner = button.querySelector('.button-spinner');
    const icon = button.querySelector('.button-icon');
    const text = button.querySelector('.button-text');
    
    if (isLoading) {
        // Mostrar loading
        button.disabled = true;
        if (spinner) spinner.classList.remove('d-none');
        if (icon) icon.classList.add('d-none');
        if (text) text.textContent = customText || 'Processando...';
        button.classList.add('loading');
    } else {
        // Esconder loading
        button.disabled = false;
        if (spinner) spinner.classList.add('d-none');
        if (icon) icon.classList.remove('d-none');
        if (text) {
            // Restaurar texto original baseado no ID do botão
            const originalTexts = {
                'btn-agrupar': 'Agrupar',
                'btn-escalar': 'Escalar',
                'btn-precificar': 'Precificar',
                'btn-confirmar-exclusao': 'Excluir Escala'
            };
            
            text.textContent = originalTexts[button.id] || 'Processar';
        }
        button.classList.remove('loading');
    }
}

// Reset do estado dos botões quando a página é descarregada
window.addEventListener('beforeunload', function() {
    const actionButtons = ['btn-agrupar', 'btn-escalar', 'btn-precificar'];
    
    actionButtons.forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) setButtonLoading(button, false);
    });
});

document.addEventListener('DOMContentLoaded', function() {
    // Event listeners específicos para os formulários de ação
    const formAgrupar = document.getElementById('form-agrupar');
    const formEscalar = document.getElementById('form-escalar');
    
    // Verificar se elementos existem antes de adicionar listeners
    if (formAgrupar) {
        console.log('Form Agrupar encontrado - configurando listener');
        formAgrupar.addEventListener('submit', function(e) {
            console.log('=== FORM AGRUPAR SUBMIT ===');
            
            // Ativar loading no botão agrupar
            const btnAgrupar = document.getElementById('btn-agrupar');
            if (btnAgrupar) {
                setButtonLoading(btnAgrupar, true, 'Agrupando...');
            }
            
            // CORREÇÃO: Garantir que o parâmetro acao seja enviado
            const existingAcao = this.querySelector('input[name="acao"]');
            if (!existingAcao) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'acao';
                hiddenInput.value = 'agrupar';
                this.appendChild(hiddenInput);
                console.log('✅ Adicionado input hidden para acao=agrupar');
            }
            
            // Permitir o submit normal
            return true;
        });
    } else {
        console.warn('Form Agrupar NÃO encontrado');
    }
    
    // Debug específico do botão agrupar
    const btnAgrupar = document.getElementById('btn-agrupar');
    if (btnAgrupar) {
        console.log('Botão Agrupar encontrado - configurando listener adicional');
        btnAgrupar.addEventListener('click', function(e) {
            console.log('=== BOTÃO AGRUPAR CLICADO ===');
            console.log('Target:', e.target);
            console.log('Form:', this.form);
        });
    } else {
        console.warn('Botão Agrupar NÃO encontrado');
    }
    
    if (formEscalar) {
        console.log('Form Escalar encontrado - configurando listener');
        formEscalar.addEventListener('submit', function(e) {
            console.log('=== FORM ESCALAR SUBMIT ===');
            
            // Ativar loading no botão escalar
            const btnEscalar = document.getElementById('btn-escalar');
            if (btnEscalar) {
                setButtonLoading(btnEscalar, true, 'Otimizando...');
            }
            
            // CORREÇÃO: Garantir que o parâmetro acao seja enviado
            const existingAcao = this.querySelector('input[name="acao"]');
            if (!existingAcao) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'acao';
                hiddenInput.value = 'otimizar';
                this.appendChild(hiddenInput);
                console.log('✅ Adicionado input hidden para acao=otimizar');
            }
            
            // Permitir o submit normal
            return true;
        });
    } else {
        console.warn('Form Escalar NÃO encontrado');
    }
    
    // Debug específico do botão escalar
    const btnEscalar = document.getElementById('btn-escalar');
    if (btnEscalar) {
        console.log('Botão Escalar encontrado - configurando listener adicional');
        btnEscalar.addEventListener('click', function(e) {
            console.log('=== BOTÃO ESCALAR CLICADO ===');
            console.log('Target:', e.target);
            console.log('Form:', this.form);
        });
    } else {
        console.warn('Botão Escalar NÃO encontrado');
    }
    
    // Event listener para o botão precificar (não é um form submit)
    const btnPrecificar = document.getElementById('btn-precificar');
    if (btnPrecificar) {
        console.log('Botão Precificar encontrado');
        btnPrecificar.addEventListener('click', function(e) {
            console.log('=== BOTÃO PRECIFICAR CLICADO ===');
            setButtonLoading(btnPrecificar, true, 'Precificando...');
            // O loading será resetado quando a página recarregar ou pelo beforeunload
        });
    } else {
        console.warn('Botão Precificar NÃO encontrado');
    }
    
    // Configuração do sistema Kanban
    const servicoCards = document.querySelectorAll('.servico-card');
    const containers = document.querySelectorAll('[data-van]');
    
    console.log(`Sistema Kanban: ${servicoCards.length} cards encontrados, ${containers.length} containers encontrados`);
    
    // Configurar drag and drop para cada cartão de serviço
    servicoCards.forEach((card, index) => {
        // Verificar se o card tem os atributos necessários
        if (!card.dataset.alocacaoId) {
            console.warn(`Card ${index} não tem alocacao-id:`, card);
        }
        
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragover', handleCardDragOver);
        card.addEventListener('drop', handleCardDrop);
        
        // Adicionar duplo clique para desagrupar
        card.addEventListener('dblclick', handleDoubleClick);
        
        // Adicionar menu de contexto
        card.addEventListener('contextmenu', handleRightClick);
        
        // Adicionar clique simples para abrir modal de detalhes
        card.addEventListener('click', handleCardClick);
    });
    
    // Configurar drop zones
    containers.forEach((container, index) => {
        console.log(`Configurando container ${index}:`, container.id, 'van:', container.dataset.van);
        container.addEventListener('dragover', handleDragOver);
        container.addEventListener('drop', handleDrop);
        container.addEventListener('dragenter', handleDragEnter);
        container.addEventListener('dragleave', handleDragLeave);
    });
    
    let draggedElement = null;
    
    function handleDragStart(e) {
        console.log('Drag started:', this.dataset.alocacaoId);
        this.classList.add('dragging');
        draggedElement = this;
        
        // Verificar se tem o ID necessário
        if (!this.dataset.alocacaoId) {
            console.error('Card não tem alocacao-id:', this);
            e.preventDefault();
            return false;
        }
        
        e.dataTransfer.setData('text/plain', this.dataset.alocacaoId);
        e.dataTransfer.effectAllowed = 'move';
        
        return true;
    }
    
    function handleDragEnd(e) {
        console.log('Drag ended');
        this.classList.remove('dragging');
        draggedElement = null;
        // Remover highlights de todos os cards e containers
        document.querySelectorAll('.servico-card').forEach(card => {
            card.classList.remove('drop-target');
        });
        document.querySelectorAll('[data-van]').forEach(container => {
            container.classList.remove('drag-over');
        });
    }
    
    function handleCardDragOver(e) {
        e.preventDefault();
        if (draggedElement && draggedElement !== this) {
            // Só adiciona highlight se realmente sobre o cartão
            const rect = this.getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // Verifica se está realmente sobre o cartão (com margem de precisão)
            if (mouseX >= rect.left + 10 && mouseX <= rect.right - 10 &&
                mouseY >= rect.top + 10 && mouseY <= rect.bottom - 10) {
                this.classList.add('drop-target');
                e.dataTransfer.dropEffect = 'copy'; // Indica agrupamento
            } else {
                this.classList.remove('drop-target');
                e.dataTransfer.dropEffect = 'move'; // Indica movimentação
            }
        }
    }
    
    function handleCardDrop(e) {
        e.preventDefault();
        
        this.classList.remove('drop-target');
        
        if (draggedElement && draggedElement !== this) {
            // Verifica se está realmente sobre o cartão para agrupar
            const rect = this.getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // Só agrupa se solto BEM NO CENTRO do cartão
            if (mouseX >= rect.left + 20 && mouseX <= rect.right - 20 &&
                mouseY >= rect.top + 20 && mouseY <= rect.bottom - 20) {
                
                e.stopPropagation(); // Impede movimentação
                
                // Agrupar serviços
                const alocacaoOrigemId = draggedElement.dataset.alocacaoId;
                const alocacaoDestinoId = this.dataset.alocacaoId;
                
                fetch('{% url "escalas:agrupar_servicos" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        alocacao_origem_id: alocacaoOrigemId,
                        alocacao_destino_id: alocacaoDestinoId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('Serviços agrupados com sucesso!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage('Erro ao agrupar serviços: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showMessage('Erro ao agrupar serviços', 'error');
                });
            }
            // Se não está bem no centro, deixa que o handleDrop do container processe a movimentação
        }
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        if (draggedElement) {
            e.dataTransfer.dropEffect = 'move';
            
            // Adicionar destaque visual se não está sobre um card
            if (!e.target.closest('.servico-card')) {
                this.classList.add('drag-over');
            }
        }
    }
    
    function handleDragEnter(e) {
        e.preventDefault();
        if (draggedElement && !e.target.closest('.servico-card')) {
            console.log('Entering drop zone:', this.dataset.van);
            this.classList.add('drag-over');
        }
    }
    
    function handleDragLeave(e) {
        // Só remove se realmente saiu do container
        if (!this.contains(e.relatedTarget)) {
            console.log('Leaving drop zone:', this.dataset.van);
            this.classList.remove('drag-over');
        }
    }
    
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const alocacaoId = e.dataTransfer.getData('text/plain');
        const novaVan = this.dataset.van;
        
        console.log('Drop:', {alocacaoId, novaVan, draggedElement});
        
        if (!draggedElement || !alocacaoId) {
            console.warn('Drop inválido: elemento não arrastado ou ID ausente');
            return;
        }
        
        // Verificar se a van atual é diferente da nova van
        const vanAtual = draggedElement.dataset.van;
        if (vanAtual === novaVan) {
            // Mesma van - só reorganizar se necessário
            showMessage('Serviço já está nesta van', 'info');
            return;
        }
        
        console.log(`Movendo serviço de ${vanAtual} para ${novaVan}`);
        
        // Mover o serviço via AJAX
        fetch('{% url "escalas:mover_servico" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                alocacao_id: alocacaoId,
                nova_van: novaVan,
                nova_posicao: 0
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const mensagem = data.message || `Serviço movido para ${novaVan === 'VAN1' ? 'Van 1' : 'Van 2'}!`;
                showMessage(mensagem, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('Erro ao mover serviço: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showMessage('Erro ao mover serviço', 'error');
        });
    }
    
    // Duplo clique para desagrupar
    function handleDoubleClick(e) {
        e.preventDefault();
        const alocacaoId = this.dataset.alocacaoId;
        const isGrouped = this.querySelector('.border-success');
        
        if (isGrouped) {
            desagruparServico(alocacaoId, 'Duplo clique para desagrupar detectado!');
        }
    }
    
    // Clique direito para menu de contexto
    function handleRightClick(e) {
        e.preventDefault();
        const alocacaoId = this.dataset.alocacaoId;
        const isGrouped = this.querySelector('.border-success');
        
        // Remover menu anterior se existir
        const existingMenu = document.querySelector('.context-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
        
        // Criar menu de contexto
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.cssText = `
            position: fixed;
            top: ${e.clientY}px;
            left: ${e.clientX}px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 9999;
            min-width: 200px;
        `;
        
        if (isGrouped) {
            menu.innerHTML = `
                <div class="menu-item" onclick="desagruparServico(${alocacaoId}, 'Removido via menu de contexto')">
                    <i class="fas fa-unlink text-danger"></i> Remover do grupo
                </div>
                <div class="menu-item" onclick="desagruparGrupoCompleto(${alocacaoId})">
                    <i class="fas fa-object-ungroup text-warning"></i> Desagrupar grupo completo
                </div>
            `;
        } else {
            menu.innerHTML = `
                <div class="menu-item disabled">
                    <i class="fas fa-info-circle text-muted"></i> Serviço não está agrupado
                </div>
                <div class="menu-item-hint">
                    Dica: Arraste sobre outro serviço para agrupar
                </div>
            `;
        }
        
        document.body.appendChild(menu);
        
        // Remover menu ao clicar fora
        setTimeout(() => {
            document.addEventListener('click', function removeMenu() {
                menu.remove();
                document.removeEventListener('click', removeMenu);
            });
        }, 100);
    }
    
    // Clique simples para abrir modal de detalhes
    function handleCardClick(e) {
        // Prevenir se estiver arrastando ou em contexto menu
        if (e.ctrlKey || e.shiftKey || e.detail > 1) {
            return;
        }
        
        // Não abrir modal se clicou em botão específico ou ícone de edição
        if (e.target.closest('button') || e.target.closest('.btn') || e.target.classList.contains('fa-edit')) {
            console.log('DEBUG: Clique em botão detectado, não processando modal');
            return;
        }
        
        // Não processar se clicou em formulário
        if (e.target.closest('form')) {
            console.log('DEBUG: Clique em formulário detectado, não processando modal');
            return;
        }
        
        const alocacaoId = this.dataset.alocacaoId;
        
        // Verificar se este serviço está em um grupo
        const isGrouped = this.querySelector('.border-success') || this.closest('.grupo-servicos');
        
        if (isGrouped) {
            // Abrir modal de grupo
            abrirModalGrupo(alocacaoId);
        } else {
            // Abrir modal de serviço individual
            abrirModalDetalhes(alocacaoId);
        }
    }
});

// Função para abrir modal e carregar dados
function abrirModalDetalhes(alocacaoId) {
    fetch(`{% url "escalas:detalhes_servico" %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            preencherModalDetalhes(data.servico, data.alocacao);
            const modal = new bootstrap.Modal(document.getElementById('modalDetalhesServico'));
            modal.show();
        } else {
            showMessage('Erro ao carregar detalhes: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao carregar detalhes do serviço', 'error');
    });
}

// Função para abrir modal de grupo e carregar dados
function abrirModalGrupo(alocacaoId) {
    fetch(`{% url "escalas:detalhes_grupo" %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            preencherModalGrupo(data.grupo, data.servicos);
            const modal = new bootstrap.Modal(document.getElementById('modalDetalhesGrupo'));
            modal.show();
        } else {
            showMessage('Erro ao carregar detalhes do grupo: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao carregar detalhes do grupo', 'error');
    });
}

// Função para preencher o modal de grupo com dados
function preencherModalGrupo(grupo, servicos) {
    // Informações básicas do grupo
    document.getElementById('editGrupoCliente').value = grupo.cliente_principal || '';
    document.getElementById('editGrupoServico').value = grupo.servico_principal || '';
    document.getElementById('editGrupoPickup').value = grupo.local_pickup_principal || '';
    document.getElementById('editGrupoVan').value = grupo.van || '';
    document.getElementById('editGrupoTotalPax').value = grupo.total_pax || 0;
    document.getElementById('editGrupoTotal').value = grupo.total_valor || 0;
    document.getElementById('editGrupoId').value = grupo.id;
    
    // Preencher lista de serviços
    const listaContainer = document.getElementById('listaServicosGrupo');
    listaContainer.innerHTML = '';
    
    servicos.forEach((servico, index) => {
        const horarioFormatado = servico.horario ? servico.horario : 'SEM HORARIO';
        const numeroVendaFormatado = servico.numero_venda ? `<br><small class="text-warning"><i class="fas fa-ticket-alt"></i> Venda: ${servico.numero_venda}</small>` : '';
        const servicoHtml = `
            <div class="border-bottom pb-2 mb-2" data-servico-id="${servico.alocacao_id}">
                <div class="row">
                    <div class="col-md-4">
                        <strong>${servico.cliente}</strong>
                        <br><small class="text-muted">${servico.servico}</small>
                        ${servico.local_pickup ? `<br><small class="text-success"><i class="fas fa-location-dot"></i> ${servico.local_pickup}</small>` : ''}
                        ${numeroVendaFormatado}
                    </div>
                    <div class="col-md-2 text-center">
                        <span class="badge bg-info">${servico.pax} PAX</span>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-clock text-primary me-1"></i>
                            <span class="fw-bold">${horarioFormatado}</span>
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" 
                                    onclick="editarHorarioServico(${servico.alocacao_id}, '${servico.horario || ''}')"
                                    title="Editar horário">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="removerServicoDoGrupo(${servico.alocacao_id})">
                            <i class="fas fa-unlink"></i> Remover
                        </button>
                    </div>
                </div>
            </div>
        `;
        listaContainer.insertAdjacentHTML('beforeend', servicoHtml);
    });
    
    // Atualizar título do modal
    document.getElementById('modalGrupoLabel').innerHTML = 
        `<i class="fas fa-layer-group"></i> Grupo: ${grupo.cliente_principal} (${servicos.length} serviços)`;
}

// Função para preencher o modal com dados
function preencherModalDetalhes(servico, alocacao) {
    // Informações básicas
    document.getElementById('editCliente').value = servico.cliente || '';
    document.getElementById('editPax').value = servico.pax || '';
    document.getElementById('editServico').value = servico.servico || '';
    document.getElementById('editPickup').value = servico.local_pickup || '';
    
    // Data e horário
    document.getElementById('editHorario').value = servico.horario || '';
    document.getElementById('editDataServico').value = servico.data_do_servico || '';
    
    // Informações da venda
    document.getElementById('editNumeroVenda').value = servico.numero_venda || '';
    
    // Características do serviço
    document.getElementById('editTipo').value = servico.tipo || 'OUTRO';
    document.getElementById('editDirecao').value = servico.direcao || 'N/A';
    document.getElementById('editAeroporto').value = servico.aeroporto || 'N/A';
    document.getElementById('editRegiao').value = servico.regiao || 'N/A';
    
    // Características especiais
    document.getElementById('editEhRegular').checked = servico.eh_regular || false;
    document.getElementById('editEhPrioritario').checked = servico.eh_prioritario || false;
    
    // Van atual
    document.getElementById('editVan').value = alocacao.van || ' ';
    
    // IDs para salvamento
    document.getElementById('editServicoId').value = servico.id;
    document.getElementById('editAlocacaoId').value = alocacao.id;
    
    // Atualizar título do modal
    document.getElementById('modalDetalhesLabel').innerHTML = 
        `<i class="fas fa-edit"></i> Editando: ${servico.cliente} - ${servico.pax} PAX`;
}

// Event listeners para o modal
document.addEventListener('DOMContentLoaded', function() {
    // Salvar edições de serviço individual
    document.getElementById('btnSalvarEdicao').addEventListener('click', function() {
        salvarEdicoesServico();
    });
    
    // Excluir serviço
    document.getElementById('btnExcluirServico').addEventListener('click', function() {
        excluirServico();
    });
    
    // Salvar edições de grupo
    document.getElementById('btnSalvarGrupo').addEventListener('click', function() {
        salvarEdicoesGrupo();
    });
    
    // Desagrupar todos os serviços
    document.getElementById('btnDesagruparTodos').addEventListener('click', function() {
        desagruparTodosServicos();
    });
});

// Função para salvar as edições
function salvarEdicoesServico() {
    const formData = new FormData(document.getElementById('formEditarServico'));
    const data = Object.fromEntries(formData);
    
    fetch('{% url "escalas:salvar_edicao_servico" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Serviço atualizado com sucesso!', 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesServico'));
            modal.hide();
            // Recarregar página para mostrar mudanças
            setTimeout(() => window.location.href = window.location.href, 1000);
        } else {
            showMessage('Erro ao salvar: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao salvar alterações', 'error');
    });
}

// Função para excluir um serviço
function excluirServico() {
    const alocacaoId = document.getElementById('editAlocacaoId').value;
    const cliente = document.getElementById('editCliente').value;
    const pax = document.getElementById('editPax').value;
    
    if (!confirm(`Tem certeza que deseja EXCLUIR o serviço "${cliente}" (${pax} PAX)?\n\n⚠️ Esta ação não pode ser desfeita!`)) {
        return;
    }
    
    fetch('{% url "escalas:excluir_servico" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesServico'));
            modal.hide();
            // Recarregar página para mostrar mudanças
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro ao excluir serviço: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao excluir serviço', 'error');
    });
}

// Função para salvar as edições de grupo
function salvarEdicoesGrupo() {
    const formData = new FormData(document.getElementById('formEditarGrupo'));
    const data = Object.fromEntries(formData);
    
    fetch('{% url "escalas:salvar_edicao_grupo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Grupo atualizado com sucesso!', 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesGrupo'));
            modal.hide();
            // Recarregar página para mostrar mudanças
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro ao salvar grupo: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao salvar alterações do grupo', 'error');
    });
}

// Função para desagrupar todos os serviços do grupo
function desagruparTodosServicos() {
    if (!confirm('Deseja desagrupar TODOS os serviços deste grupo? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    const grupoId = document.getElementById('editGrupoId').value;
    
    // Usar primeira alocação do grupo para a chamada
    const primeiraAlocacao = document.querySelector('#listaServicosGrupo [data-servico-id]');
    if (!primeiraAlocacao) {
        showMessage('Erro: Não foi possível identificar as alocações do grupo', 'error');
        return;
    }
    
    const alocacaoId = primeiraAlocacao.dataset.servicoId;
    
    fetch('{% url "escalas:desagrupar_grupo_completo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Grupo desagrupado com sucesso!', 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesGrupo'));
            modal.hide();
            // Recarregar página para mostrar mudanças
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro ao desagrupar: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao desagrupar grupo', 'error');
    });
}

// Função para desagrupar serviço
function desagruparServico(alocacaoId, customMessage = null) {
    const message = customMessage || 'Deseja remover este serviço do grupo?';
    if (!confirm(message)) {
        return;
    }
    
    fetch('{% url "escalas:desagrupar_servico" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Serviço removido do grupo!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao desagrupar serviço', 'error');
    });
}

// Função para desagrupar grupo completo
function desagruparGrupoCompleto(alocacaoId) {
    if (!confirm('Deseja desagrupar TODOS os serviços deste grupo?')) {
        return;
    }
    
    fetch('{% url "escalas:desagrupar_grupo_completo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Grupo desagrupado completamente!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao desagrupar grupo', 'error');
    });
}

// Função para editar horário de serviço individual em grupo
function editarHorarioServico(alocacaoId, horarioAtual) {
    const novoHorario = prompt(`Editar horário do serviço:\n\nFormato: HH:MM (exemplo: 14:30)`, horarioAtual || '');
    
    if (novoHorario === null) {
        return; // Usuário cancelou
    }
    
    // Validar formato do horário
    if (novoHorario && !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(novoHorario)) {
        alert('Formato de horário inválido. Use HH:MM (exemplo: 14:30)');
        return;
    }
    
    fetch('{% url "escalas:editar_horario_servico" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId,
            horario: novoHorario
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Horário atualizado com sucesso!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao editar horário', 'error');
    });
}

// ===== SISTEMA DE FILTROS =====
document.addEventListener('DOMContentLoaded', function() {
    // Elementos dos filtros
    const filtroPaxMin = document.getElementById('filtro-pax-min');
    const filtroPaxMax = document.getElementById('filtro-pax-max');
    const filtroServico = document.getElementById('filtro-servico');
    const filtroPickup = document.getElementById('filtro-pickup');
    const filtroVan = document.getElementById('filtro-van');
    const filtroStatus = document.getElementById('filtro-status');
    const clearFilters = document.getElementById('clearFilters');
    const filtroStats = document.getElementById('filtro-stats');
    
    // Botões de filtro rápido
    const filtroPaxAlto = document.getElementById('filtro-pax-alto');
    const filtroPaxBaixo = document.getElementById('filtro-pax-baixo');
    const filtroHotelbeds = document.getElementById('filtro-hotelbeds');
    const filtroHoliday = document.getElementById('filtro-holiday');
    const filtroTransferIn = document.getElementById('filtro-transfer-in');
    const filtroTransferOut = document.getElementById('filtro-transfer-out');
    const filtroBarra = document.getElementById('filtro-barra');
    const filtroPrioritarios = document.getElementById('filtro-prioritarios');
    const filtroAlocados = document.getElementById('filtro-alocados');
    const filtroNaoAlocados = document.getElementById('filtro-nao-alocados');
    
    // Todos os cards de serviço
    const servicoCards = document.querySelectorAll('.servico-card');
    
    // Função para aplicar filtros
    function aplicarFiltros() {
        // Validar se os elementos existem
        if (!filtroPaxMin || !filtroPaxMax || !filtroServico || !filtroPickup || !filtroVan) {
            console.warn('Alguns elementos de filtro não foram encontrados');
            return;
        }
        
        const paxMin = parseInt(filtroPaxMin.value) || 0;
        const paxMax = parseInt(filtroPaxMax.value) || 999;
        const servicoTexto = filtroServico.value.toLowerCase();
        const pickupTexto = filtroPickup.value.toLowerCase();
        const vanSelecionada = filtroVan.value;
        const statusSelecionado = filtroStatus ? filtroStatus.value : '';
        
        let servicosVisiveis = 0;
        let paxVisivel = 0;
        let van1Visiveis = 0;
        let van2Visiveis = 0;
        
        servicoCards.forEach(card => {
            const pax = parseInt(card.dataset.pax) || 0;
            const servico = (card.dataset.servico || '').toLowerCase();
            const pickup = (card.dataset.pickup || '').toLowerCase();
            const van = card.dataset.van || '';
            const status = card.dataset.status || '';
            
            // Verificar filtros
            const passaPax = pax >= paxMin && pax <= paxMax;
            const passaServico = !servicoTexto || servico.includes(servicoTexto);
            const passaPickup = !pickupTexto || pickup.includes(pickupTexto);
            const passaVan = !vanSelecionada || van === vanSelecionada;
            const passaStatus = !statusSelecionado || status === statusSelecionado;
            
            // Mostrar/ocultar card
            if (passaPax && passaServico && passaPickup && passaVan && passaStatus) {
                card.style.display = 'block';
                servicosVisiveis++;
                paxVisivel += pax;
                if (van === 'VAN1') van1Visiveis++;
                else van2Visiveis++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Atualizar estatísticas
        atualizarEstatisticas(servicosVisiveis, paxVisivel, van1Visiveis, van2Visiveis);
    }
    
    // Função para atualizar estatísticas
    function atualizarEstatisticas(servicos, pax, van1, van2) {
        const total = servicoCards.length;
        if (servicos === total) {
            filtroStats.textContent = `${servicos} serviços (${pax} PAX)`;
        } else {
            filtroStats.innerHTML = `
                <strong>${servicos}</strong>/${total} serviços (${pax} PAX) | V1: ${van1} | V2: ${van2}
            `;
        }
        
        // Atualizar totais das vans
        atualizarTotaisVans();
    }
    
    // Função para atualizar totais das vans baseado nos serviços visíveis
    function atualizarTotaisVans() {
        // Calcular totais Van 1
        const van1Cards = document.querySelectorAll('#van1-container .servico-card[style*="block"], #van1-container .servico-card:not([style*="none"])');
        let van1Pax = 0, van1Valor = 0, van1Count = 0;
        
        van1Cards.forEach(card => {
            if (card.style.display !== 'none') {
                van1Pax += parseInt(card.dataset.pax) || 0;
                van1Valor += parseFloat(card.dataset.valor) || 0;
                van1Count++;
            }
        });
        
        // Calcular totais Van 2
        const van2Cards = document.querySelectorAll('#van2-container .servico-card[style*="block"], #van2-container .servico-card:not([style*="none"])');
        let van2Pax = 0, van2Valor = 0, van2Count = 0;
        
        van2Cards.forEach(card => {
            if (card.style.display !== 'none') {
                van2Pax += parseInt(card.dataset.pax) || 0;
                van2Valor += parseFloat(card.dataset.valor) || 0;
                van2Count++;
            }
        });
        
        // Atualizar interface
        document.getElementById('van1-pax').textContent = `${van1Pax} PAX`;
        document.getElementById('van1-valor').textContent = formatarMoeda(van1Valor);
        document.getElementById('van1-servicos').textContent = `${van1Count} serviços`;
        
        document.getElementById('van2-pax').textContent = `${van2Pax} PAX`;
        document.getElementById('van2-valor').textContent = formatarMoeda(van2Valor);
        document.getElementById('van2-servicos').textContent = `${van2Count} serviços`;
    }
    
    // Função para formatar valores em moeda
    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(valor);
    }
    
    // Função para limpar filtros
    function limparFiltros() {
        if (filtroPaxMin) filtroPaxMin.value = '';
        if (filtroPaxMax) filtroPaxMax.value = '';
        if (filtroServico) filtroServico.value = '';
        if (filtroPickup) filtroPickup.value = '';
        if (filtroVan) filtroVan.value = '';
        if (filtroStatus) filtroStatus.value = '';
        
        // Remover classes ativas dos botões - incluindo todas as variações
        document.querySelectorAll('.btn-outline-primary.active, .btn-outline-secondary.active, .btn-outline-warning.active, .btn-outline-info.active, .btn-outline-success.active, .btn-outline-danger.active, .btn-outline-dark.active')
                .forEach(btn => btn.classList.remove('active'));
        
        aplicarFiltros();
    }
    
    // Função para aplicar filtro por cliente
    function aplicarFiltroCliente(clienteBusca) {
        let servicosVisiveis = 0;
        let paxVisivel = 0;
        let van1Visiveis = 0;
        let van2Visiveis = 0;
        
        servicoCards.forEach(card => {
            const pax = parseInt(card.dataset.pax);
            const cliente = card.dataset.cliente ? card.dataset.cliente.toLowerCase() : '';
            
            if (cliente.includes(clienteBusca.toLowerCase())) {
                card.style.display = 'block';
                servicosVisiveis++;
                paxVisivel += pax;
                if (card.dataset.van === 'VAN1') van1Visiveis++;
                else van2Visiveis++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Atualizar estatísticas
        atualizarEstatisticas(servicosVisiveis, paxVisivel, van1Visiveis, van2Visiveis);
    }
    
    // Função para aplicar filtro por serviço
    function aplicarFiltroServico(servicoBusca) {
        let servicosVisiveis = 0;
        let paxVisivel = 0;
        let van1Visiveis = 0;
        let van2Visiveis = 0;
        
        servicoCards.forEach(card => {
            const pax = parseInt(card.dataset.pax);
            const servico = card.dataset.servico ? card.dataset.servico.toLowerCase() : '';
            
            if (servico.includes(servicoBusca.toLowerCase())) {
                card.style.display = 'block';
                servicosVisiveis++;
                paxVisivel += pax;
                if (card.dataset.van === 'VAN1') van1Visiveis++;
                else van2Visiveis++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Atualizar estatísticas
        atualizarEstatisticas(servicosVisiveis, paxVisivel, van1Visiveis, van2Visiveis);
    }
    
    // Função para aplicar filtro de prioritários
    function aplicarFiltroPrioritarios() {
        let servicosVisiveis = 0;
        let paxVisivel = 0;
        let van1Visiveis = 0;
        let van2Visiveis = 0;
        
        servicoCards.forEach(card => {
            const pax = parseInt(card.dataset.pax);
            const servico = card.dataset.servico ? card.dataset.servico.toLowerCase() : '';
            const cliente = card.dataset.cliente ? card.dataset.cliente.toLowerCase() : '';
            
            // Critérios para prioritários:
            // 1. PAX entre 4-10
            const isPaxPrioritario = pax >= 4 && pax <= 10;
            
            if (isPaxPrioritario) {
                // 2. Hotelbeds ou Holiday no cliente
                const isHotelbedsHoliday = cliente.includes('hotelbeds') || cliente.includes('holiday');
                
                // 3. Barra da Tijuca no serviço  
                const isBarraTijuca = servico.includes('barra') || servico.includes('recreio');
                
                // É prioritário se tem 4-10 PAX E (Hotelbeds/Holiday OU Barra)
                const isPrioritario = isHotelbedsHoliday || isBarraTijuca;
                
                if (isPrioritario) {
                    card.style.display = 'block';
                    servicosVisiveis++;
                    paxVisivel += pax;
                    if (card.dataset.van === 'VAN1') van1Visiveis++;
                    else van2Visiveis++;
                } else {
                    card.style.display = 'none';
                }
            } else {
                card.style.display = 'none';
            }
        });
        
        // Atualizar estatísticas
        atualizarEstatisticas(servicosVisiveis, paxVisivel, van1Visiveis, van2Visiveis);
    }
    
    // Função para aplicar filtro por status
    function aplicarFiltroStatus(statusBusca) {
        let servicosVisiveis = 0;
        let paxVisivel = 0;
        let van1Visiveis = 0;
        let van2Visiveis = 0;
        
        servicoCards.forEach(card => {
            const pax = parseInt(card.dataset.pax);
            const status = card.dataset.status;
            
            if (status === statusBusca) {
                card.style.display = 'block';
                servicosVisiveis++;
                paxVisivel += pax;
                if (card.dataset.van === 'VAN1') van1Visiveis++;
                else van2Visiveis++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Atualizar estatísticas
        atualizarEstatisticas(servicosVisiveis, paxVisivel, van1Visiveis, van2Visiveis);
    }
    
    // Event listeners para filtros
    if (filtroPaxMin) filtroPaxMin.addEventListener('input', aplicarFiltros);
    if (filtroPaxMax) filtroPaxMax.addEventListener('input', aplicarFiltros);
    if (filtroServico) filtroServico.addEventListener('input', aplicarFiltros);
    if (filtroPickup) filtroPickup.addEventListener('input', aplicarFiltros);
    if (filtroVan) filtroVan.addEventListener('change', aplicarFiltros);
    if (filtroStatus) filtroStatus.addEventListener('change', aplicarFiltros);
    if (clearFilters) clearFilters.addEventListener('click', limparFiltros);
    
    // Filtros rápidos
    // Event listeners para botões de filtro rápido
    if (filtroPaxAlto) {
        filtroPaxAlto.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                filtroPaxMin.value = '4';
                this.classList.add('active');
                aplicarFiltros();
            }
        });
    }
    
    if (filtroPaxBaixo) {
        filtroPaxBaixo.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                filtroPaxMin.value = '1';
                filtroPaxMax.value = '3';
                this.classList.add('active');
                aplicarFiltros();
            }
        });
    }
    
    if (filtroHotelbeds) {
        filtroHotelbeds.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                aplicarFiltroCliente('hotelbeds');
                this.classList.add('active');
            }
        });
    }
    
    if (filtroHoliday) {
        filtroHoliday.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                aplicarFiltroCliente('holiday');
                this.classList.add('active');
            }
        });
    }
    
    if (filtroTransferIn) {
        filtroTransferIn.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                aplicarFiltroServico('transfer in');
                this.classList.add('active');
            }
        });
    }
    
    if (filtroTransferOut) {
        filtroTransferOut.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                aplicarFiltroServico('transfer out');
                this.classList.add('active');
            }
        });
    }
    
    if (filtroBarra) {
        filtroBarra.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                aplicarFiltroServico('barra');
                this.classList.add('active');
            }
        });
    }
    
    if (filtroPrioritarios) {
        filtroPrioritarios.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                aplicarFiltroPrioritarios();
                this.classList.add('active');
            }
        });
    }
    
    if (filtroAlocados) {
        filtroAlocados.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                aplicarFiltroStatus('ALOCADO');
                this.classList.add('active');
            }
        });
    }
    
    if (filtroNaoAlocados) {
        filtroNaoAlocados.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                // Duplo clique - remover filtro
                limparFiltros();
            } else {
                limparFiltros();
                aplicarFiltroStatus('NAO_ALOCADO');
                this.classList.add('active');
            }
        });
    }
    
    // Aplicar filtros inicial
    aplicarFiltros();
    
    // Atualizar totais das vans na inicialização
    setTimeout(() => {
        atualizarTotaisVans();
    }, 100);
});

// Função para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Função para abrir modal de tarifários
function abrirModalTarifarios(servicoId, tipo, grupoId = null) {
    // Armazenar informações do serviço selecionado
    document.getElementById('servicoIdSelecionado').value = servicoId;
    document.getElementById('tipoSelecionado').value = tipo;
    if (grupoId) {
        document.getElementById('grupoIdSelecionado').value = grupoId;
    }
    
    // Carregar dados dos tarifários
    carregarTarifarios();
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalTarifarios'));
    modal.show();
}

// Função para carregar dados dos tarifários
function carregarTarifarios() {
    fetch('/escalas/api/tarifarios/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                preencherTabelaJW(data.tarifario_jw);
                preencherTabelaMotoristas(data.tarifario_motoristas);
            } else {
                console.error('Erro ao carregar tarifários:', data.error);
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
        });
}

// Função para preencher tabela do tarifário JW
function preencherTabelaJW(tarifarioJW) {
    const tbody = document.getElementById('tabelaJW');
    tbody.innerHTML = '';
    
    const veiculos = ['Executivo', 'Van 15 lugares', 'Van 18 lugares', 'Micro', 'Ônibus'];
    
    for (const [servico, precos] of Object.entries(tarifarioJW)) {
        const row = document.createElement('tr');
        
        // Coluna do serviço
        const cellServico = document.createElement('td');
        cellServico.innerHTML = `<strong>${servico}</strong>`;
        row.appendChild(cellServico);
        
        // Colunas dos veículos
        veiculos.forEach(veiculo => {
            const cell = document.createElement('td');
            if (precos[veiculo]) {
                const preco = parseFloat(precos[veiculo]);
                
                const badge = document.createElement('span');
                badge.className = 'badge bg-success';
                badge.style.cursor = 'pointer';
                badge.textContent = `R$ ${preco.toFixed(2)}`;
                badge.addEventListener('click', function() {
                    aplicarPrecoSelecionado(preco, servico, veiculo);
                });
                
                cell.appendChild(badge);
            } else {
                cell.innerHTML = '<span class="badge bg-secondary">N/A</span>';
            }
            row.appendChild(cell);
        });
        
        tbody.appendChild(row);
    }
}

// Função para preencher tabela do tarifário de motoristas
function preencherTabelaMotoristas(tarifarioMotoristas) {
    const tbody = document.getElementById('tabelaMotoristas');
    tbody.innerHTML = '';
    
    for (const [servico, preco] of Object.entries(tarifarioMotoristas)) {
        const row = document.createElement('tr');
        
        // Criar células
        const cellServico = document.createElement('td');
        cellServico.innerHTML = `<strong>${servico}</strong>`;
        
        const cellPreco = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary';
        badge.style.cursor = 'pointer';
        badge.textContent = `R$ ${preco.toFixed(2)}`;
        badge.addEventListener('click', function() {
            aplicarPrecoSelecionado(preco, servico, 'Motorista');
        });
        cellPreco.appendChild(badge);
        
        const cellObs = document.createElement('td');
        cellObs.innerHTML = '<small class="text-muted">Multiplicado pelo número de venda</small>';
        
        row.appendChild(cellServico);
        row.appendChild(cellPreco);
        row.appendChild(cellObs);
        
        tbody.appendChild(row);
    }
}

// Função para aplicar preço selecionado
function aplicarPrecoSelecionado(preco, servicoOrigem, veiculo) {
    console.log('🎯 aplicarPrecoSelecionado chamada:', { preco, servicoOrigem, veiculo });
    
    const servicoId = document.getElementById('servicoIdSelecionado').value;
    const tipo = document.getElementById('tipoSelecionado').value;
    const grupoId = document.getElementById('grupoIdSelecionado').value;
    
    console.log('📊 Dados do serviço:', { servicoId, tipo, grupoId });
    
    if (!servicoId) {
        console.error('servicoId não encontrado!');
        alert('Erro: ID do serviço não encontrado. Tente fechar e abrir o modal novamente.');
        return;
    }
    
    // Verificar se existe Bootstrap
    if (!window.bootstrap) {
        console.error('Bootstrap não disponível!');
        alert('Erro: Bootstrap não carregado. Recarregue a página.');
        return;
    }
    
    // Armazenar dados para confirmação
    window.precoParaConfirmar = {
        preco: preco,
        servicoOrigem: servicoOrigem,
        veiculo: veiculo,
        servicoId: servicoId,
        tipo: tipo,
        grupoId: grupoId
    };
    
    // Verificar se modal de confirmação existe primeiro
    const modalConfirmacaoEl = document.getElementById('modalConfirmacaoPreco');
    if (!modalConfirmacaoEl) {
        console.error('❌ Modal de confirmação não encontrado no DOM!');
        alert('Erro: Modal de confirmação não encontrado. Verifique se a página carregou completamente.');
        return;
    }
    
    // Fechar modal de tarifários primeiro
    const modalTarifarios = bootstrap.Modal.getInstance(document.getElementById('modalTarifarios'));
    if (modalTarifarios) {
        console.log('� Fechando modal de tarifários...');
        modalTarifarios.hide();
    }
    
    // Função para preencher modal quando estiver pronto
    function preencherModalConfirmacao() {
        console.log('📝 Tentando preencher modal de confirmação...');
        
        // Estratégia múltipla para encontrar elementos
        let precoEl = null;
        let origemEl = null;
        
        // Estratégia 1: IDs diretos
        precoEl = document.getElementById('precoConfirmacao');
        origemEl = document.getElementById('origemConfirmacao');
        console.log('🔍 Estratégia 1 - IDs diretos:', {precoEl, origemEl});
        
        // Estratégia 2: Buscar dentro do modal
        if (!precoEl || !origemEl) {
            precoEl = precoEl || modalConfirmacaoEl.querySelector('#precoConfirmacao');
            origemEl = origemEl || modalConfirmacaoEl.querySelector('#origemConfirmacao');
            console.log('🔍 Estratégia 2 - Dentro do modal:', {precoEl, origemEl});
        }
        
        // Estratégia 3: Buscar por classes e contexto
        if (!precoEl) {
            precoEl = modalConfirmacaoEl.querySelector('.badge.bg-success');
            console.log('🔍 Estratégia 3 - Badge verde encontrado:', precoEl);
        }
        
        if (!origemEl) {
            // Buscar span que não seja badge
            const spans = Array.from(modalConfirmacaoEl.querySelectorAll('span'));
            origemEl = spans.find(span => 
                !span.classList.contains('badge') && 
                span.textContent.trim() !== '' &&
                !span.textContent.includes('R$')
            );
            console.log('🔍 Estratégia 3 - Span para origem encontrado:', origemEl);
        }
        
        // Estratégia 4: Forçar criação com base na estrutura existente
        if (!precoEl || !origemEl) {
            console.warn('⚠️ Elementos não encontrados, analisando estrutura...');
            console.log('🔍 HTML completo do modal:', modalConfirmacaoEl.innerHTML);
            
            // Tentar encontrar qualquer estrutura que possa ser usada
            const rows = modalConfirmacaoEl.querySelectorAll('.row');
            console.log('🔍 Rows encontradas:', rows.length);
            
            rows.forEach((row, index) => {
                console.log(`🔍 Row ${index}:`, row.innerHTML);
            });
        }
        
        console.log('🔍 Elementos finais após todas as estratégias:', { precoEl, origemEl });
        
        if (!precoEl || !origemEl) {
            console.error('❌ Ainda não foi possível encontrar os elementos!');
            console.log('🔍 Estrutura do modal:', modalConfirmacaoEl.innerHTML);
            
            // Última tentativa: recriar elementos do zero
            const alertDiv = modalConfirmacaoEl.querySelector('.alert.alert-info');
            console.log('🔍 Alert div encontrado:', alertDiv);
            
            if (alertDiv) {
                console.log('✅ Recriando estrutura do modal...');
                alertDiv.innerHTML = `
                    <div class="row">
                        <div class="col-6"><strong>Preço:</strong></div>
                        <div class="col-6">
                            <span class="badge bg-success fs-6" id="precoConfirmacao">R$ ${preco.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6"><strong>Origem:</strong></div>
                        <div class="col-6">
                            <span id="origemConfirmacao">${servicoOrigem} - ${veiculo}</span>
                        </div>
                    </div>
                `;
                console.log('✅ Elementos recriados com sucesso!');
                return true;
            } else {
                console.error('❌ Não foi possível encontrar div.alert.alert-info');
                
                // Buscar qualquer div que possa servir
                const modalBody = modalConfirmacaoEl.querySelector('.modal-body');
                console.log('🔍 Modal body encontrado:', modalBody);
                
                if (modalBody) {
                    // Encontrar onde inserir o conteúdo
                    let targetDiv = modalBody.querySelector('.alert') || modalBody;
                    
                    // Se não houver alert, criar um
                    if (!modalBody.querySelector('.alert')) {
                        console.log('📝 Criando estrutura alert do zero...');
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-info mt-3';
                        
                        // Inserir depois do h5 que contém "Aplicar o seguinte preço?"
                        const h5 = modalBody.querySelector('h5');
                        if (h5) {
                            h5.insertAdjacentElement('afterend', alertDiv);
                            targetDiv = alertDiv;
                        } else {
                            modalBody.appendChild(alertDiv);
                            targetDiv = alertDiv;
                        }
                    }
                    
                    targetDiv.innerHTML = `
                        <div class="row">
                            <div class="col-6"><strong>Preço:</strong></div>
                            <div class="col-6">
                                <span class="badge bg-success fs-6" id="precoConfirmacao">R$ ${preco.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6"><strong>Origem:</strong></div>
                            <div class="col-6">
                                <span id="origemConfirmacao">${servicoOrigem} - ${veiculo}</span>
                            </div>
                        </div>
                    `;
                    console.log('✅ Estrutura criada dinamicamente!');
                    return true;
                } else {
                    console.error('❌ Não foi possível encontrar .modal-body');
                    alert('Erro crítico: Modal não possui estrutura esperada. Recarregue a página.');
                    return false;
                }
            }
        }
        
        // Preencher elementos normalmente
        if (precoEl && origemEl) {
            // Garantir que os elementos tenham IDs corretos
            if (!precoEl.id) precoEl.id = 'precoConfirmacao';
            if (!origemEl.id) origemEl.id = 'origemConfirmacao';
            
            precoEl.textContent = `R$ ${preco.toFixed(2)}`;
            origemEl.textContent = `${servicoOrigem} - ${veiculo}`;
            console.log('✅ Elementos preenchidos com sucesso!');
            return true;
        } else {
            console.warn('⚠️ Um ou ambos elementos ainda são null, tentando recriação...');
            return false;
        }
    }
    
    // Abrir modal de confirmação e preencher
    setTimeout(() => {
        console.log('⏱️ Abrindo modal de confirmação...');
        
        try {
            const modalConfirmacao = new bootstrap.Modal(modalConfirmacaoEl);
            
            // Aguardar o modal ser mostrado completamente
            modalConfirmacaoEl.addEventListener('shown.bs.modal', function preencherAposAbrir() {
                console.log('🎉 Modal de confirmação totalmente carregado!');
                preencherModalConfirmacao();
                // Remover listener para evitar duplicação
                modalConfirmacaoEl.removeEventListener('shown.bs.modal', preencherAposAbrir);
            });
            
            modalConfirmacao.show();
            console.log('✅ Modal de confirmação disparado para abertura');
            
        } catch (error) {
            console.error('❌ Erro ao abrir modal de confirmação:', error);
            alert('Erro ao abrir modal de confirmação: ' + error.message);
        }
    }, 300);
}

// Função para confirmar e aplicar o preço
function confirmarAplicacaoPreco() {
    const dados = window.precoParaConfirmar;
    
    if (!dados) {
        alert('Erro: dados do preço não encontrados.');
        return;
    }
    
    // Mostrar loading
    document.getElementById('btnConfirmarPreco').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...';
    document.getElementById('btnConfirmarPreco').disabled = true;
    
    // Preparar dados para envio
    const dadosEnvio = {
        servico_id: dados.servicoId,
        preco: dados.preco,
        tipo: dados.tipo,
        fonte: `${dados.servicoOrigem} - ${dados.veiculo}`
    };
    
    if (dados.grupoId) {
        dadosEnvio.grupo_id = dados.grupoId;
    }
    
    fetch('/escalas/api/atualizar-preco/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dadosEnvio)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fechar modal de confirmação
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacaoPreco'));
            modal.hide();
            
            // Mostrar sucesso e recarregar
            mostrarNotificacaoSucesso(`Preço atualizado para R$ ${dados.preco.toFixed(2)}`);
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            alert('Erro ao atualizar preço: ' + data.error);
            // Restaurar botão
            document.getElementById('btnConfirmarPreco').innerHTML = '<i class="fas fa-check"></i> Confirmar';
            document.getElementById('btnConfirmarPreco').disabled = false;
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        alert('Erro ao atualizar preço.');
        // Restaurar botão
        document.getElementById('btnConfirmarPreco').innerHTML = '<i class="fas fa-check"></i> Confirmar';
        document.getElementById('btnConfirmarPreco').disabled = false;
    });
}

// Função para mostrar notificação de sucesso
function mostrarNotificacaoSucesso(mensagem) {
    // Criar elemento de notificação
    const notificacao = document.createElement('div');
    notificacao.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notificacao.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notificacao.innerHTML = `
        <i class="fas fa-check-circle"></i> ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notificacao);
    
    // Remover após 3 segundos
    setTimeout(() => {
        if (notificacao.parentNode) {
            notificacao.remove();
        }
    }, 3000);
}

// Função para aplicar preço customizado
function aplicarPrecoCustomizado() {
    const precoInput = document.getElementById('precoCustomizado');
    if (!precoInput) {
        showMessage('Erro: Campo de preço não encontrado', 'error');
        return;
    }
    
    const preco = parseFloat(precoInput.value);
    
    if (isNaN(preco) || preco <= 0) {
        showMessage('Por favor, insira um preço válido.', 'error');
        return;
    }
    
    // Verificar se os elementos existem antes de usar
    const servicoIdEl = document.getElementById('servicoIdSelecionado');
    const tipoEl = document.getElementById('tipoSelecionado');
    const grupoIdEl = document.getElementById('grupoIdSelecionado');
    
    if (!servicoIdEl || !tipoEl || !grupoIdEl) {
        showMessage('Erro: Dados do serviço não encontrados', 'error');
        return;
    }
    
    const servicoId = servicoIdEl.value;
    const tipo = tipoEl.value;
    const grupoId = grupoIdEl.value;
    
    // Armazenar dados para confirmação
    window.precoParaConfirmar = {
        preco: preco,
        servicoOrigem: 'Preço',
        veiculo: 'Customizado',
        servicoId: servicoId,
        tipo: tipo,
        grupoId: grupoId
    };
    
    // Verificar se elementos de confirmação existem
    const precoConfirmacaoEl = document.getElementById('precoConfirmacao');
    const origemConfirmacaoEl = document.getElementById('origemConfirmacao');
    
    if (precoConfirmacaoEl && origemConfirmacaoEl) {
        precoConfirmacaoEl.textContent = `R$ ${preco.toFixed(2)}`;
        origemConfirmacaoEl.textContent = 'Preço Customizado';
    }
    
    // Fechar modal de tarifários e abrir modal de confirmação
    const modalTarifariosEl = document.getElementById('modalTarifarios');
    if (modalTarifariosEl) {
        const modalTarifarios = bootstrap.Modal.getInstance(modalTarifariosEl);
        if (modalTarifarios) {
            modalTarifarios.hide();
        }
    }
    
    const modalConfirmacao = new bootstrap.Modal(document.getElementById('modalConfirmacaoPreco'));
    modalConfirmacao.show();
}

// Funcionalidade de busca nas tabelas
document.addEventListener('DOMContentLoaded', function() {
    // Busca no tarifário JW
    document.getElementById('buscaJW').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const linhas = document.querySelectorAll('#tabelaJW tr');
        
        linhas.forEach(linha => {
            const texto = linha.textContent.toLowerCase();
            linha.style.display = texto.includes(termo) ? '' : 'none';
        });
    });
    
    // Busca no tarifário de motoristas
    document.getElementById('buscaMotoristas').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const linhas = document.querySelectorAll('#tabelaMotoristas tr');
        
        linhas.forEach(linha => {
            const texto = linha.textContent.toLowerCase();
            linha.style.display = texto.includes(termo) ? '' : 'none';
        });
    });
    
    // Verificação de elementos essenciais para tarifários
    console.log('🚀 Verificando elementos essenciais para funcionalidade de tarifários...');
    
    const elementosEssenciais = [
        'modalConfirmacaoPreco',
        'precoConfirmacao', 
        'origemConfirmacao',
        'modalTarifarios'
    ];
    
    const elementosEncontrados = {};
    const elementosAusentes = [];
    
    elementosEssenciais.forEach(id => {
        const elemento = document.getElementById(id);
        elementosEncontrados[id] = elemento;
        if (!elemento) {
            elementosAusentes.push(id);
        }
    });
    
    console.log('✅ Elementos encontrados:', elementosEncontrados);
    
    if (elementosAusentes.length > 0) {
        console.error('❌ Elementos ausentes:', elementosAusentes);
        console.log('🔍 Total de elementos com ID no documento:', document.querySelectorAll('[id]').length);
        console.warn('⚠️ Funcionalidade de tarifários pode não funcionar corretamente!');
    } else {
        console.log('✅ Todos os elementos essenciais para tarifários encontrados!');
    }
});

function setButtonLoading(button, isLoading, loadingText) {
    if (!button) {
        return;
    }

    const spinner = button.querySelector('.button-spinner');
    const icon = button.querySelector('.button-icon');
    const text = button.querySelector('.button-text');

    if (isLoading) {
        if (text && !button.dataset.originalText) {
            button.dataset.originalText = text.textContent.trim();
        }

        if (text && loadingText) {
            text.textContent = loadingText;
        }

        if (spinner) {
            spinner.classList.remove('d-none');
        }

        if (icon) {
            icon.classList.add('d-none');
        }

        button.setAttribute('disabled', 'disabled');
    } else {
        if (spinner) {
            spinner.classList.add('d-none');
        }

        if (icon) {
            icon.classList.remove('d-none');
        }

        if (text) {
            const originalText = button.dataset.originalText;
            if (originalText) {
                text.textContent = originalText;
            }
        }

        button.removeAttribute('disabled');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const formAgrupar = document.getElementById('form-agrupar');
    if (formAgrupar) {
        formAgrupar.addEventListener('submit', function() {
            const button = formAgrupar.querySelector('button[type="submit"]');
            setButtonLoading(button, true, 'Agrupando...');
        });
    }

    const formEscalar = document.getElementById('form-escalar');
    if (formEscalar) {
        formEscalar.addEventListener('submit', function() {
            const button = formEscalar.querySelector('button[type="submit"]');
            setButtonLoading(button, true, 'Escalando...');
        });
    }
});

// Função para precificar escala manualmente
function precificarEscala() {
    const dataEscala = '{{ data }}';
    const precificarButton = document.getElementById('btn-precificar');

    // Verificar se data existe
    if (!dataEscala) {
        showMessage('Erro: Data da escala não encontrada', 'error');
        return;
    }

    // Mostrar mensagem de carregamento
    showMessage('Precificando escala...', 'success');
    setButtonLoading(precificarButton, true, 'Precificando...');

    // Fazer requisição AJAX para precificar a escala
    fetch(`/escalas/precificar/${dataEscala}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(result => {
        if (result.status === 'success' || result.success === true) {
            showMessage(result.message || 'Precificação concluída com sucesso!', 'success');
            // Recarregar a página após 2 segundos para mostrar os preços atualizados
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage(result.message || result.error || 'Erro ao precificar escala', 'error');
        }
    })
    .catch(error => {
        console.error('Erro na precificação:', error);
        showMessage(`Erro ao precificar escala: ${error.message}`, 'error');
    })
    .finally(() => {
        setButtonLoading(precificarButton, false);
    });
}
</script>

<!-- Modal de Detalhes e Edição do Serviço -->
<div class="modal fade" id="modalDetalhesServico" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesLabel">
                    <i class="fas fa-edit"></i> Detalhes e Edição do Serviço
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarServico">
                    <!-- Informações Básicas -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="editCliente" class="form-label">
                                <i class="fas fa-user"></i> Cliente
                            </label>
                            <input type="text" class="form-control" id="editCliente" name="cliente">
                        </div>
                        <div class="col-md-4">
                            <label for="editPax" class="form-label">
                                <i class="fas fa-users"></i> PAX
                            </label>
                            <input type="number" class="form-control" id="editPax" name="pax" min="1">
                        </div>
                    </div>

                    <!-- Serviço e Pickup -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editServico" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> Serviço
                            </label>
                            <textarea class="form-control" id="editServico" name="servico" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editPickup" class="form-label">
                                <i class="fas fa-location-dot"></i> Local de Pickup
                            </label>
                            <input type="text" class="form-control" id="editPickup" name="local_pickup">
                        </div>
                    </div>

                    <!-- Horário e Data -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editHorario" class="form-label">
                                <i class="fas fa-clock"></i> Horário
                            </label>
                            <input type="time" class="form-control" id="editHorario" name="horario">
                        </div>
                        <div class="col-md-6">
                            <label for="editDataServico" class="form-label">
                                <i class="fas fa-calendar"></i> Data do Serviço
                            </label>
                            <input type="date" class="form-control" id="editDataServico" name="data_do_servico" lang="pt-BR">
                        </div>
                    </div>

                    <!-- Informações da Venda -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editNumeroVenda" class="form-label">
                                <i class="fas fa-hashtag"></i> Número da Venda
                            </label>
                            <input type="text" class="form-control" id="editNumeroVenda" name="numero_venda">
                        </div>
                    </div>

                    <!-- Características do Serviço -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="editTipo" class="form-label">
                                <i class="fas fa-layer-group"></i> Tipo
                            </label>
                            <select class="form-control" id="editTipo" name="tipo">
                                <option value="TRANSFER">Transfer</option>
                                <option value="DISPOSICAO">Disposição</option>
                                <option value="TOUR">Tour</option>
                                <option value="OUTRO">Outro</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="editDirecao" class="form-label">
                                <i class="fas fa-arrows-alt-h"></i> Direção
                            </label>
                            <select class="form-control" id="editDirecao" name="direcao">
                                <option value="IN">IN</option>
                                <option value="OUT">OUT</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="editAeroporto" class="form-label">
                                <i class="fas fa-plane"></i> Aeroporto
                            </label>
                            <select class="form-control" id="editAeroporto" name="aeroporto">
                                <option value="GIG">GIG</option>
                                <option value="SDU">SDU</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="editRegiao" class="form-label">
                                <i class="fas fa-map"></i> Região
                            </label>
                            <select class="form-control" id="editRegiao" name="regiao">
                                <option value="ZONA SUL">Zona Sul</option>
                                <option value="SANTOS DUMONT">Santos Dumont</option>
                                <option value="BARRA">Barra</option>
                                <option value="CENTRO">Centro</option>
                                <option value="BUZIOS">Búzios</option>
                                <option value="ANGRA">Angra</option>
                                <option value="PETROPOLIS">Petrópolis</option>
                                <option value="PARATY">Paraty</option>
                                <option value="MACAE">Macaé</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                    </div>

                    <!-- Características Especiais -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editEhRegular" name="eh_regular">
                                <label class="form-check-label" for="editEhRegular">
                                    <i class="fas fa-sync"></i> É Regular
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editEhPrioritario" name="eh_prioritario">
                                <label class="form-check-label" for="editEhPrioritario">
                                    <i class="fas fa-star"></i> É Prioritário
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Van Atual -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editVan" class="form-label">
                                <i class="fas fa-van-shuttle"></i> Van Atual
                            </label>
                            <select class="form-control" id="editVan" name="van">
                                <option value="VAN1">Van 1</option>
                                <option value="VAN2">Van 2</option>
                            </select>
                        </div>
                    </div>

                    <!-- IDs ocultos -->
                    <input type="hidden" id="editServicoId" name="servico_id">
                    <input type="hidden" id="editAlocacaoId" name="alocacao_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnExcluirServico">
                    <i class="fas fa-trash"></i> Excluir Serviço
                </button>
                <button type="button" class="btn btn-primary" id="btnSalvarEdicao">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Edição de Grupo -->
<div class="modal fade" id="modalDetalhesGrupo" tabindex="-1" aria-labelledby="modalGrupoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalGrupoLabel">
                    <i class="fas fa-layer-group"></i> Detalhes do Grupo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarGrupo">
                    <!-- Informações Gerais do Grupo -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="editGrupoCliente" class="form-label">
                                <i class="fas fa-user"></i> Cliente Principal
                            </label>
                            <input type="text" class="form-control" id="editGrupoCliente" name="cliente_principal">
                        </div>
                        <div class="col-md-4">
                            <label for="editGrupoTotalPax" class="form-label">
                                <i class="fas fa-users"></i> Total PAX
                            </label>
                            <input type="number" class="form-control" id="editGrupoTotalPax" name="total_pax" readonly>
                        </div>
                    </div>

                    <!-- Serviço e Local Principal -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editGrupoServico" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> Serviço Principal
                            </label>
                            <textarea class="form-control" id="editGrupoServico" name="servico_principal" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editGrupoPickup" class="form-label">
                                <i class="fas fa-location-dot"></i> Local de Pickup Principal
                            </label>
                            <input type="text" class="form-control" id="editGrupoPickup" name="local_pickup_principal">
                        </div>
                    </div>

                    <!-- Van do Grupo -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editGrupoVan" class="form-label">
                                <i class="fas fa-van-shuttle"></i> Van do Grupo
                            </label>
                            <select class="form-control" id="editGrupoVan" name="van">
                                <option value="VAN1">Van 1</option>
                                <option value="VAN2">Van 2</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editGrupoTotal" class="form-label">
                                <i class="fas fa-dollar-sign"></i> Valor Total
                            </label>
                            <input type="number" class="form-control" id="editGrupoTotal" name="total_valor" step="0.01" readonly>
                        </div>
                    </div>

                    <!-- Lista de Serviços do Grupo -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-list"></i> Serviços no Grupo
                        </label>
                        <div id="listaServicosGrupo" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <!-- Será preenchido dinamicamente -->
                        </div>
                    </div>

                    <!-- IDs ocultos -->
                    <input type="hidden" id="editGrupoId" name="grupo_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnDesagruparTodos">
                    <i class="fas fa-unlink"></i> Desagrupar Todos
                </button>
                <button type="button" class="btn btn-primary" id="btnSalvarGrupo">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Tarifários para Edição de Preços -->
<div class="modal fade" id="modalTarifarios" tabindex="-1" aria-labelledby="modalTarifariosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTarifariosLabel">
                    <i class="fas fa-dollar-sign"></i> Escolher Preço dos Tarifários
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Navegação por Abas -->
                <ul class="nav nav-tabs" id="tarifarioModalTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="jw-modal-tab" data-bs-toggle="tab" data-bs-target="#jw-modal" type="button" role="tab">
                            <i class="fas fa-bus"></i> Tarifário JW
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="motoristas-modal-tab" data-bs-toggle="tab" data-bs-target="#motoristas-modal" type="button" role="tab">
                            <i class="fas fa-user-tie"></i> Tarifário Motoristas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="customizado-modal-tab" data-bs-toggle="tab" data-bs-target="#customizado-modal" type="button" role="tab">
                            <i class="fas fa-edit"></i> Preço Customizado
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="tarifarioModalTabContent">
                    <!-- Tarifário JW -->
                    <div class="tab-pane fade show active" id="jw-modal" role="tabpanel">
                        <div class="mt-3">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="buscaJW" placeholder="Buscar serviço no tarifário JW...">
                            </div>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Serviço</th>
                                            <th>Executivo</th>
                                            <th>Van 15</th>
                                            <th>Van 18</th>
                                            <th>Micro</th>
                                            <th>Ônibus</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaJW">
                                        <!-- Será preenchido dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tarifário Motoristas -->
                    <div class="tab-pane fade" id="motoristas-modal" role="tabpanel">
                        <div class="mt-3">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="buscaMotoristas" placeholder="Buscar serviço no tarifário de motoristas...">
                            </div>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Serviço</th>
                                            <th>Preço Base</th>
                                            <th>Observação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaMotoristas">
                                        <!-- Será preenchido dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Preço Customizado -->
                    <div class="tab-pane fade" id="customizado-modal" role="tabpanel">
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="precoCustomizado" class="form-label">
                                        <i class="fas fa-dollar-sign"></i> Preço Personalizado
                                    </label>
                                    <input type="number" class="form-control" id="precoCustomizado" 
                                           placeholder="0.00" step="0.01" min="0">
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" class="btn btn-success" onclick="aplicarPrecoCustomizado()">
                                        <i class="fas fa-check"></i> Aplicar Preço
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações Ocultas -->
                <input type="hidden" id="servicoIdSelecionado">
                <input type="hidden" id="tipoSelecionado">
                <input type="hidden" id="grupoIdSelecionado">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes de Precificação -->
<div class="modal fade" id="modalDetalhesPrecificacao" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetalhesLabel">
                    <i class="fas fa-chart-line"></i> Detalhes da Precificação
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="conteudoDetalhesPreco">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando detalhes...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Aplicação de Preço -->
<div class="modal fade" id="modalConfirmacaoPreco" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalConfirmacaoLabel">
                    <i class="fas fa-dollar-sign"></i> Confirmar Aplicação de Preço
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-question-circle text-primary" style="font-size: 3rem;"></i>
                </div>
                <h5>Aplicar o seguinte preço?</h5>
                <div class="alert alert-info mt-3">
                    <div class="row">
                        <div class="col-6">
                            <strong>Preço:</strong>
                        </div>
                        <div class="col-6">
                            <span class="badge bg-success fs-6" id="precoConfirmacao">R$ 0,00</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <strong>Origem:</strong>
                        </div>
                        <div class="col-6">
                            <span id="origemConfirmacao">-</span>
                        </div>
                    </div>
                </div>
                <p class="text-muted small">Esta ação substituirá o preço atual do serviço.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarPreco" onclick="confirmarAplicacaoPreco()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Função para exibir detalhes da precificação
function verDetalhesPreco(alocacaoId) {
    console.log('📊 Abrindo detalhes de precificação para alocação:', alocacaoId);
    
    // Exibir o modal com loading
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhesPrecificacao'));
    modal.show();
    
    // Carregar os detalhes via AJAX
    fetch(`/escalas/api/detalhes-precificacao/${alocacaoId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Construir o HTML com os detalhes expandidos
            let html = `
                <!-- Informações do Serviço -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Informações do Serviço</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-4"><strong>Número de Venda:</strong></div>
                            <div class="col-8"><code>${data.numero_venda}</code></div>
                        </div>
                        <div class="row">
                            <div class="col-4"><strong>Cliente:</strong></div>
                            <div class="col-8">${data.cliente}</div>
                        </div>
                        <div class="row">
                            <div class="col-4"><strong>Serviço:</strong></div>
                            <div class="col-8"><small>${data.servico_nome}</small></div>
                        </div>
                        <div class="row">
                            <div class="col-4"><strong>PAX:</strong></div>
                            <div class="col-8"><span class="badge bg-info">${data.pax}</span></div>
                        </div>
                        <div class="row">
                            <div class="col-4"><strong>Origem/Pickup:</strong></div>
                            <div class="col-8">${data.origem}</div>
                        </div>
                        <div class="row">
                            <div class="col-4"><strong>Destino/Região:</strong></div>
                            <div class="col-8">${data.destino}</div>
                        </div>
                        <div class="row">
                            <div class="col-4"><strong>Tipo:</strong></div>
                            <div class="col-8"><span class="badge bg-secondary">${data.tipo_servico || 'N/A'}</span></div>
                        </div>
                        <div class="row">
                            <div class="col-4"><strong>Direção:</strong></div>
                            <div class="col-8"><span class="badge bg-primary">${data.direcao || 'N/A'}</span></div>
                        </div>
                    </div>
                </div>

                <!-- Detalhes da Precificação -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-calculator"></i> Cálculo de Preço</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row mb-2">
                            <div class="col-6"><strong>Preço Final:</strong></div>
                            <div class="col-6"><span class="badge bg-success fs-6">R$ ${data.preco_calculado}</span></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6"><strong>Veículo Recomendado:</strong></div>
                            <div class="col-6"><span class="badge bg-info">${data.veiculo_recomendado}</span></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6"><strong>Lucratividade/PAX:</strong></div>
                            <div class="col-6"><span class="badge bg-warning text-dark">R$ ${data.lucratividade}</span></div>
                        </div>
            `;
            
            // Detalhes do tarifário
            if (data.preco_tabela) {
                html += `
                        <div class="row mb-2">
                            <div class="col-6"><strong>Preço da Tabela:</strong></div>
                            <div class="col-6"><span class="badge bg-secondary">R$ ${data.preco_tabela}</span></div>
                        </div>
                `;
            }
            
            if (data.multiplicador && data.multiplicador !== 1) {
                html += `
                        <div class="row mb-2">
                            <div class="col-6"><strong>Multiplicador:</strong></div>
                            <div class="col-6"><span class="badge bg-warning text-dark">${data.multiplicador}x</span></div>
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>

                <!-- Fonte do Tarifário -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-database"></i> Fonte dos Dados</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row mb-2">
                            <div class="col-6"><strong>Tarifário Utilizado:</strong></div>
                            <div class="col-6"><span class="badge bg-info">${data.fonte_tarifario}</span></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6"><strong>Método de Cálculo:</strong></div>
                            <div class="col-6"><span class="badge bg-secondary">${data.metodo_calculo}</span></div>
                        </div>
            `;
            
            if (data.tarifa_encontrada) {
                html += `
                        <div class="row mb-2">
                            <div class="col-6"><strong>Termo Encontrado:</strong></div>
                            <div class="col-6"><code class="small">${data.tarifa_encontrada}</code></div>
                        </div>
                `;
            }
            
            if (data.score_similaridade !== undefined && data.score_similaridade !== null) {
                const corScore = data.score_similaridade >= 0.8 ? 'success' : 
                               data.score_similaridade >= 0.6 ? 'warning' : 'danger';
                html += `
                        <div class="row mb-2">
                            <div class="col-6"><strong>Confiança da Busca:</strong></div>
                            <div class="col-6"><span class="badge bg-${corScore}">${(data.score_similaridade * 100).toFixed(1)}%</span></div>
                        </div>
                `;
            }
            
            if (data.data_calculo && data.data_calculo !== 'N/A') {
                html += `
                        <div class="row mb-2">
                            <div class="col-6"><strong>Data do Cálculo:</strong></div>
                            <div class="col-6"><small>${data.data_calculo}</small></div>
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // Observações
            if (data.observacoes) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-sticky-note"></i> Observações</h6>
                        </div>
                        <div class="card-body p-2">
                            <small>${data.observacoes}</small>
                        </div>
                    </div>
                `;
            }
            
            // Histórico de busca
            if (data.historico_busca && data.historico_busca.length > 0) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="fas fa-history"></i> Histórico de Busca</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Termo Pesquisado</th>
                                            <th>Confiança</th>
                                            <th>Preço</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.historico_busca.forEach(item => {
                    const cor = item.score >= 0.8 ? 'success' : 
                               item.score >= 0.6 ? 'warning' : 'danger';
                    html += `
                        <tr>
                            <td><code class="small">${item.termo}</code></td>
                            <td><span class="badge bg-${cor}">${(item.score * 100).toFixed(1)}%</span></td>
                            <td>R$ ${item.preco}</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Debug info (opcional - pode ser removido em produção)
            if (data.todos_detalhes && Object.keys(data.todos_detalhes).length > 0) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0"><i class="fas fa-bug"></i> Debug - Dados Brutos 
                                <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#debugData">
                                    Ver/Ocultar
                                </button>
                            </h6>
                        </div>
                        <div class="collapse" id="debugData">
                            <div class="card-body p-2">
                                <pre class="small">${JSON.stringify(data.todos_detalhes, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Atualizar o conteúdo do modal
            document.getElementById('conteudoDetalhesPreco').innerHTML = html;
        })
        .catch(error => {
            console.error('❌ Erro ao carregar detalhes:', error);
            document.getElementById('conteudoDetalhesPreco').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar os detalhes da precificação.
                    <br><small>Erro: ${error.message}</small>
                </div>
            `;
        });
}

// Adicionar listener para tornar os badges de preço clicáveis ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Encontrar todos os badges de preço que contêm valor monetário
    const precosBadges = document.querySelectorAll('.badge.bg-success');
    
    precosBadges.forEach(badge => {
        // Verificar se o badge contém valor monetário (R$)
        if (badge.textContent.includes('R$')) {
            // Encontrar o elemento pai que contém o data-alocacao-id
            const servicoItem = badge.closest('[data-alocacao-id]');
            
            if (servicoItem) {
                const alocacaoId = servicoItem.getAttribute('data-alocacao-id');
                
                // Adicionar classe e eventos de clique
                badge.classList.add('preco-clicavel');
                badge.style.cursor = 'pointer';
                badge.title = 'Clique para ver detalhes da precificação';
                
                badge.addEventListener('click', function(event) {
                    event.stopPropagation();
                    verDetalhesPreco(alocacaoId);
                });
            }
        }
    });
    
    console.log('✅ Listeners de detalhes de precificação configurados');
    
    // Configurar listeners para toggle de status de alocação
    const statusBadges = document.querySelectorAll('.clickable-status');
    statusBadges.forEach(badge => {
        badge.addEventListener('click', function(event) {
            event.stopPropagation();
            toggleStatusAlocacao(this);
        });
    });
    
    console.log('✅ Listeners de toggle de status configurados');
});

// Função para alternar status de alocação
function toggleStatusAlocacao(badge) {
    const alocacaoId = badge.getAttribute('data-alocacao-id');
    const statusAtual = badge.getAttribute('data-status-atual');
    const novoStatus = statusAtual === 'ALOCADO' ? 'NAO_ALOCADO' : 'ALOCADO';
    
    // Mostrar loading
    const textoOriginal = badge.textContent;
    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Alterando...';
    badge.style.pointerEvents = 'none';
    
    // Fazer requisição AJAX
    fetch('{% url "escalas:toggle_status_alocacao" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId,
            novo_status: novoStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Se a resposta indica que houve reorganização, recarregar a página
            if (data.reorganizado) {
                showToast('Status alterado e serviços reorganizados!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                return;
            }
            
            // Atualizar o badge
            badge.setAttribute('data-status-atual', novoStatus);
            
            if (novoStatus === 'ALOCADO') {
                badge.className = 'badge bg-success px-3 py-2 text-uppercase fw-semibold status-badge clickable-status';
                badge.textContent = 'Alocado';
                badge.title = 'Clique para mudar para NÃO ALOCADO';
            } else {
                badge.className = 'badge bg-danger px-3 py-2 text-uppercase fw-semibold status-badge clickable-status';
                badge.textContent = 'Não alocado';
                badge.title = 'Clique para mudar para ALOCADO';
            }
            
            // Exibir mensagem de sucesso
            showToast('Status alterado com sucesso!', 'success');
        } else {
            badge.textContent = textoOriginal;
            showToast(data.message || 'Erro ao alterar status', 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        badge.textContent = textoOriginal;
        showToast('Erro ao alterar status', 'error');
    })
    .finally(() => {
        badge.style.pointerEvents = 'auto';
    });
}

// Função para mostrar toast
function showToast(message, type = 'info') {
    // Criar elemento toast se não existir
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(toastContainer);
    }
    
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Remover toast automaticamente após 3 segundos
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
</script>

<!-- Modal para Adicionar Serviço Manual -->
<div class="modal fade" id="modal-adicionar-servico" tabindex="-1" aria-labelledby="modalAdicionarServicoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalAdicionarServicoLabel">
                    <i class="fas fa-plus-circle"></i> Adicionar Serviço Manual - {{ escala.data|date:"d/m/Y" }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="form-adicionar-servico">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Atenção:</strong> Este serviço será adicionado diretamente à escala sem passar pela planilha. 
                        Campos obrigatórios: <strong>Serviço/Destino</strong>, <strong>Van</strong>, <strong>Número da Venda</strong> e <strong>Valor</strong>.
                    </div>
                    
                    <div class="row">
                        <!-- Cliente (opcional) -->
                        <div class="col-md-8 mb-3">
                            <label for="novo-cliente" class="form-label">
                                <i class="fas fa-user text-primary"></i>
                                Cliente
                            </label>
                            <input type="text" class="form-control" id="novo-cliente" name="cliente" 
                                   placeholder="Nome do cliente (opcional)">
                            <div class="form-text">Nome da empresa ou pessoa que contratou o serviço</div>
                        </div>
                        
                        <!-- PAX (opcional) -->
                        <div class="col-md-4 mb-3">
                            <label for="novo-pax" class="form-label">
                                <i class="fas fa-users text-info"></i>
                                PAX
                            </label>
                            <input type="number" class="form-control" id="novo-pax" name="pax" 
                                   min="1" max="50" value="1" placeholder="1">
                            <div class="form-text">Número de passageiros (padrão: 1)</div>
                        </div>
                    </div>
                    
                    <!-- Serviço (obrigatório) -->
                    <div class="mb-3">
                        <label for="novo-servico" class="form-label">
                            <i class="fas fa-map-marker-alt text-danger"></i>
                            <strong>Serviço/Destino *</strong>
                        </label>
                        <textarea class="form-control" id="novo-servico" name="servico" required rows="3" 
                                  placeholder="Descrição do serviço ou destino (ex: Transfer IN GIG x Hotel Copacabana Palace)"></textarea>
                        <div class="form-text">Descrição detalhada do serviço a ser realizado</div>
                    </div>
                    
                    <div class="row">
                        <!-- Local Pickup -->
                        <div class="col-md-8 mb-3">
                            <label for="novo-pickup" class="form-label">
                                <i class="fas fa-location-dot text-warning"></i>
                                Local de Pickup
                            </label>
                            <input type="text" class="form-control" id="novo-pickup" name="local_pickup" 
                                   placeholder="Endereço ou local de coleta">
                            <div class="form-text">Endereço onde os passageiros serão coletados</div>
                        </div>
                        
                        <!-- Horário -->
                        <div class="col-md-4 mb-3">
                            <label for="novo-horario" class="form-label">
                                <i class="fas fa-clock text-info"></i>
                                Horário
                            </label>
                            <input type="time" class="form-control" id="novo-horario" name="horario">
                            <div class="form-text">Horário do serviço (opcional)</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Número da Venda (obrigatório) -->
                        <div class="col-md-6 mb-3">
                            <label for="novo-numero-venda" class="form-label">
                                <i class="fas fa-ticket-alt text-success"></i>
                                <strong>Número da Venda *</strong>
                            </label>
                            <input type="text" class="form-control" id="novo-numero-venda" name="numero_venda" required
                                   placeholder="Número ou código da venda">
                            <div class="form-text">Referência interna da venda</div>
                        </div>
                        
                        <!-- Van (obrigatório) -->
                        <div class="col-md-6 mb-3">
                            <label for="novo-van" class="form-label">
                                <i class="fas fa-van-shuttle text-primary"></i>
                                <strong>Van *</strong>
                            </label>
                            <select class="form-select" id="novo-van" name="van" required>
                                <option value="">Selecione a van...</option>
                                <option value="VAN1">Van 1</option>
                                <option value="VAN2">Van 2</option>
                            </select>
                            <div class="form-text">Escolha a van onde o serviço será alocado</div>
                        </div>
                    </div>
                    
                    <!-- Valor (obrigatório) -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="novo-valor" class="form-label">
                                <i class="fas fa-dollar-sign text-success"></i>
                                <strong>Valor (R$) *</strong>
                            </label>
                            <input type="number" class="form-control" id="novo-valor" name="valor" required
                                   min="0" step="0.01" placeholder="0.00">
                            <div class="form-text">Valor do serviço em reais</div>
                        </div>
                        
                        <!-- Espaço para manter alinhamento -->
                        <div class="col-md-6 mb-3">
                            <!-- Vazio para manter layout -->
                        </div>
                    </div>
                    
                    <!-- Observações -->
                    <div class="mb-3">
                        <label for="novo-observacoes" class="form-label">
                            <i class="fas fa-sticky-note text-secondary"></i>
                            Observações
                        </label>
                        <textarea class="form-control" id="novo-observacoes" name="observacoes" rows="2" 
                                  placeholder="Observações adicionais sobre o serviço"></textarea>
                        <div class="form-text">Informações extras que podem ser úteis</div>
                    </div>
                    
                    <!-- Campo oculto com a data da escala -->
                    <input type="hidden" id="data-escala" name="data_escala" value="{{ escala.data|date:'d-m-Y' }}">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success" id="btn-salvar-servico">
                        <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner-adicionar"></span>
                        <i class="fas fa-plus-circle"></i> Adicionar Serviço
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Formatação -->
<div class="modal fade" id="modal-formatar" tabindex="-1" aria-labelledby="modalFormatarLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalFormatarLabel">
                    <i class="fas fa-paint-brush"></i> 
                    {% if escala.etapa == 'OTIMIZADA' %}
                        Formatar Escala Otimizada - {{ escala.data|date:"d/m/Y" }}
                    {% else %}
                        Limpar/Formatar Escala - {{ escala.data|date:"d/m/Y" }}
                    {% endif %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'escalas:formatar_escala' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="data" value="{{ escala.data|date_br }}">
                    
                    <!-- Alerta Principal -->
                    <div class="alert alert-warning border-start border-warning border-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                            <div>
                                <h6 class="mb-0"><strong>ATENÇÃO: Operação Irreversível</strong></h6>
                                <small class="text-muted">Esta ação não pode ser desfeita</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Explicação do que será feito -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle text-info"></i> 
                                {% if escala.etapa == 'OTIMIZADA' %}
                                    O que a formatação irá fazer na escala otimizada:
                                {% else %}
                                    O que a formatação irá fazer:
                                {% endif %}
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-success">
                                        <i class="fas fa-check"></i> Será mantido:
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check-circle text-success me-2"></i>Todos os serviços</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i>Dados dos clientes</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i>Horários e PAX</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i>Números de venda</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i>Locais de pickup</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-danger">
                                        <i class="fas fa-times"></i> Será removido:
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        {% if escala.etapa == 'OTIMIZADA' %}
                                            <li><i class="fas fa-times-circle text-danger me-2"></i>Status de otimização</li>
                                        {% endif %}
                                        <li><i class="fas fa-times-circle text-danger me-2"></i>Todos os agrupamentos</li>
                                        <li><i class="fas fa-times-circle text-danger me-2"></i>Preços calculados</li>
                                        <li><i class="fas fa-times-circle text-danger me-2"></i>Veículos recomendados</li>
                                        <li><i class="fas fa-times-circle text-danger me-2"></i>Status de alocação</li>
                                    </ul>
                                </div>
                            </div>
                            {% if escala.etapa == 'OTIMIZADA' %}
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Após a formatação:</strong> A escala voltará ao status "Dados Puxados" e poderá ser reagrupada e reotimizada quantas vezes necessário.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Informações de auditoria -->
                    <div class="alert alert-info border-start border-info border-4">
                        <h6><i class="fas fa-shield-alt"></i> Segurança e Auditoria:</h6>
                        <ul class="mb-0 small">
                            <li><strong>Usuário:</strong> {{ user.username }} ({{ user.get_full_name|default:user.username }})</li>
                            <li><strong>Data/Hora:</strong> <span id="timestamp-atual"></span></li>
                            <li><strong>Registro:</strong> Esta ação ficará registrada no log do sistema</li>
                            <li><strong>Rastreabilidade:</strong> IP e detalhes completos serão salvos</li>
                        </ul>
                    </div>
                    
                    <!-- Campo de senha -->
                    <div class="mb-3">
                        <label for="senha" class="form-label">
                            <i class="fas fa-lock text-danger"></i> 
                            <strong>Digite sua senha para autorizar a formatação:</strong>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-danger text-white">
                                <i class="fas fa-key"></i>
                            </span>
                            <input type="password" class="form-control" id="senha" name="senha" required 
                                   placeholder="Senha do usuário {{ user.username }}" 
                                   autocomplete="current-password">
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i>
                            Por segurança, confirme sua identidade com sua senha de usuário.
                        </div>
                    </div>
                    
                    <!-- Confirmação final -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmar-formatacao" required>
                        <label class="form-check-label" for="confirmar-formatacao">
                            <strong>Confirmo que entendo que esta operação é irreversível</strong> e que {% if escala.etapa == 'OTIMIZADA' %}a otimização, todos os agrupamentos e preços{% else %}todos os agrupamentos e preços{% endif %} serão perdidos.
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-info" id="btn-confirmar-formatacao" disabled>
                        <i class="fas fa-paint-brush"></i> Confirmar Formatação
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript para o modal de formatação -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Atualizar timestamp atual
    const timestampElement = document.getElementById('timestamp-atual');
    if (timestampElement) {
        const agora = new Date();
        timestampElement.textContent = agora.toLocaleString('pt-BR');
    }
    
    // Controlar habilitação do botão de confirmação
    const checkbox = document.getElementById('confirmar-formatacao');
    const senhaInput = document.getElementById('senha');
    const btnConfirmar = document.getElementById('btn-confirmar-formatacao');
    
    function verificarHabilitacao() {
        const senhaPreenchida = senhaInput.value.length > 0;
        const checkboxMarcado = checkbox.checked;
        btnConfirmar.disabled = !(senhaPreenchida && checkboxMarcado);
    }
    
    if (checkbox && senhaInput && btnConfirmar) {
        checkbox.addEventListener('change', verificarHabilitacao);
        senhaInput.addEventListener('input', verificarHabilitacao);
    }
    
    // Focar no campo de senha quando modal abrir
    const modalFormatar = document.getElementById('modal-formatar');
    if (modalFormatar) {
        modalFormatar.addEventListener('shown.bs.modal', function () {
            senhaInput.focus();
        });
    }
});
</script>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modal-confirmar-exclusao" tabindex="-1" aria-labelledby="modalExclusaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalExclusaoLabel">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'escalas:excluir_escala' data=escala.data|date_br %}" id="form-exclusao-escala">
                <div class="modal-body">
                    {% csrf_token %}
                    
                    <!-- Cabeçalho com ícone e data -->
                    <div class="text-center mb-4">
                        <div class="display-1 text-danger mb-3">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <h4 class="text-danger mb-0">Escala de {{ escala.data|date:"d/m/Y" }}</h4>
                    </div>
                    
                    <!-- Cards com informações -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-body text-center py-3">
                                    <div class="h1 text-warning mb-2">
                                        <i class="fas fa-concierge-bell"></i>
                                    </div>
                                    <h5 class="card-title text-warning">Serviços</h5>
                                    <h2 class="card-text text-warning" id="total-servicos-exclusao">{{ total_servicos }}</h2>
                                    <small class="text-muted">serviços serão excluídos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body text-center py-3">
                                    <div class="h1 text-info mb-2">
                                        <i class="fas fa-cog"></i>
                                    </div>
                                    <h5 class="card-title text-info">Status</h5>
                                    <h4 class="card-text text-info">{{ escala.get_etapa_display }}</h4>
                                    <small class="text-muted">estado atual</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alerta de escala otimizada -->
                    {% if escala.etapa == 'OTIMIZADA' %}
                    <div class="alert alert-warning border-start border-warning border-4 mb-4">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <strong>Escala Otimizada!</strong> Todos os dados de otimização serão perdidos permanentemente.
                    </div>
                    {% endif %}
                    
                    <!-- Campo de senha -->
                    <div class="mb-3">
                        <label for="senha-exclusao" class="form-label">
                            <i class="fas fa-lock text-danger"></i> 
                            <strong>Digite sua senha para confirmar:</strong>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-danger text-white">
                                <i class="fas fa-key"></i>
                            </span>
                            <input type="password" class="form-control" id="senha-exclusao" name="senha" required 
                                   placeholder="Sua senha atual" 
                                   autocomplete="current-password">
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i>
                            Por segurança, é necessário confirmar sua senha.
                        </div>
                        <!-- Div para mostrar erro de senha -->
                        <div id="erro-senha-exclusao" class="alert alert-danger mt-2 d-none">
                            <i class="fas fa-times-circle"></i> 
                            <strong>Senha incorreta!</strong> Verifique sua senha e tente novamente.
                        </div>
                    </div>
                    
                    <!-- Checkbox de confirmação -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmar-exclusao" required>
                        <label class="form-check-label" for="confirmar-exclusao">
                            <strong>Confirmo que entendo que esta operação é irreversível</strong> e que todos os dados desta escala serão perdidos permanentemente.
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-cancelar-exclusao">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-danger" id="btn-confirmar-exclusao" disabled>
                        <span class="spinner-border spinner-border-sm me-2 d-none button-spinner" role="status" aria-hidden="true"></span>
                        <i class="fas fa-trash-alt button-icon"></i> 
                        <span class="button-text">Excluir Escala</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript para modal de exclusão -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const senhaExclusaoInput = document.getElementById('senha-exclusao');
    const checkboxExclusao = document.getElementById('confirmar-exclusao');
    const btnConfirmarExclusao = document.getElementById('btn-confirmar-exclusao');
    const erroSenhaDiv = document.getElementById('erro-senha-exclusao');
    const formExclusao = document.getElementById('form-exclusao-escala');
    
    // Função para verificar e habilitar o botão
    function verificarHabilitacaoExclusao() {
        const senhaPreenchida = senhaExclusaoInput.value.length > 0;
        const checkboxMarcado = checkboxExclusao.checked;
        
        btnConfirmarExclusao.disabled = !(senhaPreenchida && checkboxMarcado);
        
        // Esconder erro quando usuário começar a digitar novamente
        if (senhaPreenchida) {
            erroSenhaDiv.classList.add('d-none');
        }
    }
    
    // Event listeners para validação
    if (senhaExclusaoInput && checkboxExclusao && btnConfirmarExclusao) {
        senhaExclusaoInput.addEventListener('input', verificarHabilitacaoExclusao);
        checkboxExclusao.addEventListener('change', verificarHabilitacaoExclusao);
    }
    
    // Verificar senha antes do submit
    if (formExclusao) {
        formExclusao.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const senha = senhaExclusaoInput.value;
            const dataEscala = '{{ escala.data|date:"Y-m-d" }}';
            
            // Ativar loading no botão
            setButtonLoading(btnConfirmarExclusao, true, 'Verificando...');
            
            // Verificar senha via AJAX
            fetch('{% url "escalas:verificar_senha_exclusao" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    senha: senha,
                    data: dataEscala
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.senha_correta) {
                    // Senha correta, prosseguir com exclusão
                    setButtonLoading(btnConfirmarExclusao, true, 'Excluindo...');
                    
                    // Submeter o formulário normalmente
                    formExclusao.removeEventListener('submit', arguments.callee);
                    formExclusao.submit();
                } else {
                    // Senha incorreta, mostrar erro
                    setButtonLoading(btnConfirmarExclusao, false);
                    erroSenhaDiv.classList.remove('d-none');
                    senhaExclusaoInput.focus();
                    senhaExclusaoInput.select();
                }
            })
            .catch(error => {
                console.error('Erro ao verificar senha:', error);
                setButtonLoading(btnConfirmarExclusao, false);
                erroSenhaDiv.classList.remove('d-none');
                erroSenhaDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Erro de conexão!</strong> Tente novamente.';
            });
        });
    }
    
    // Focar no campo de senha quando modal abrir
    const modalExclusao = document.getElementById('modal-confirmar-exclusao');
    if (modalExclusao && senhaExclusaoInput) {
        modalExclusao.addEventListener('shown.bs.modal', function () {
            senhaExclusaoInput.focus();
            erroSenhaDiv.classList.add('d-none');
            senhaExclusaoInput.value = '';
            checkboxExclusao.checked = false;
            verificarHabilitacaoExclusao();
        });
    }
});

// Função para exportar uma van específica para Excel
function exportarVanParaExcel(van) {
    const dataEscala = '{{ data }}';
    
    if (!dataEscala) {
        showMessage('Erro: Data da escala não encontrada', 'error');
        return;
    }
    
    // Construir URL para download do Excel específico da van
    const url = `/escalas/exportar-van/${dataEscala}/${van}/`;
    
    // Criar um link temporário e forçar o download
    const link = document.createElement('a');
    link.href = url;
    link.download = `escala_${dataEscala}_${van}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Mostrar mensagem de sucesso
    const vanNome = van === 'VAN1' ? 'Van 1' : 'Van 2';
    showMessage(`Excel da ${vanNome} baixado com sucesso!`, 'success');
}

// JavaScript para modal de adicionar serviço manual
document.addEventListener('DOMContentLoaded', function() {
    const formAdicionarServico = document.getElementById('form-adicionar-servico');
    const btnSalvarServico = document.getElementById('btn-salvar-servico');
    const spinnerAdicionar = document.getElementById('spinner-adicionar');
    const modalAdicionarServico = document.getElementById('modal-adicionar-servico');
    
    // Event listener para o formulário de adicionar serviço
    if (formAdicionarServico) {
        formAdicionarServico.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Coletar dados do formulário
            const formData = new FormData(formAdicionarServico);
            const data = Object.fromEntries(formData);
            
            // Validações básicas - apenas campos obrigatórios
            if (!data.servico.trim()) {
                showMessage('Por favor, descreva o serviço/destino', 'error');
                document.getElementById('novo-servico').focus();
                return;
            }
            
            if (!data.van) {
                showMessage('Por favor, selecione uma van', 'error');
                document.getElementById('novo-van').focus();
                return;
            }
            
            if (!data.numero_venda.trim()) {
                showMessage('Por favor, informe o número da venda', 'error');
                document.getElementById('novo-numero-venda').focus();
                return;
            }
            
            // Validar valor obrigatório
            const valor = parseFloat(data.valor);
            if (!data.valor || valor <= 0) {
                showMessage('Por favor, informe um valor positivo', 'error');
                document.getElementById('novo-valor').focus();
                return;
            }
            
            // Validar horário se preenchido
            if (data.horario && !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(data.horario)) {
                showMessage('Formato de horário inválido. Use HH:MM (ex: 14:30)', 'error');
                document.getElementById('novo-horario').focus();
                return;
            }
            
            // Mostrar loading
            btnSalvarServico.disabled = true;
            spinnerAdicionar.classList.remove('d-none');
            btnSalvarServico.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span><i class="fas fa-plus-circle"></i> Adicionando...';
            
            // Enviar dados via AJAX
            fetch('{% url "escalas:adicionar_servico_manual" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Sucesso
                    showMessage(result.message, 'success');
                    
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(modalAdicionarServico);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Limpar formulário
                    formAdicionarServico.reset();
                    
                    // Recarregar página após um tempo para mostrar o novo serviço
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    
                } else {
                    // Erro
                    showMessage('Erro ao adicionar serviço: ' + result.error, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showMessage('Erro de conexão ao adicionar serviço', 'error');
            })
            .finally(() => {
                // Restaurar botão
                btnSalvarServico.disabled = false;
                spinnerAdicionar.classList.add('d-none');
                btnSalvarServico.innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Serviço';
            });
        });
    }
    
    // Limpar formulário quando modal for aberto
    if (modalAdicionarServico) {
        modalAdicionarServico.addEventListener('shown.bs.modal', function () {
            // Focar no primeiro campo
            document.getElementById('novo-cliente').focus();
            
            // Limpar mensagens de erro anteriores
            const alerts = document.querySelectorAll('.alert-message');
            alerts.forEach(alert => alert.remove());
        });
        
        // Limpar formulário quando modal for fechado
        modalAdicionarServico.addEventListener('hidden.bs.modal', function () {
            if (formAdicionarServico) {
                formAdicionarServico.reset();
            }
        });
    }
    
    // Auto-complete para campos comuns
    const clienteInput = document.getElementById('novo-cliente');
    const servicoInput = document.getElementById('novo-servico');
    
    // Adicionar algumas sugestões comuns
    if (clienteInput) {
        clienteInput.addEventListener('input', function() {
            const valor = this.value.toLowerCase();
            // Você pode adicionar auto-complete aqui no futuro
        });
    }
    
    if (servicoInput) {
        servicoInput.addEventListener('input', function() {
            const valor = this.value.toLowerCase();
            // Sugerir direção automaticamente
            if (valor.includes('aeroporto') || valor.includes('gig') || valor.includes('sdu')) {
                if (!valor.includes(' in ') && !valor.includes(' out ')) {
                    // Sugerir adicionar direção
                }
            }
        });
    }
});

// Função para abrir o modal de adicionar serviço
function abrirModalAdicionarServico() {
    const modal = new bootstrap.Modal(document.getElementById('modal-adicionar-servico'));
    modal.show();
}
</script>

{% endblock %}
