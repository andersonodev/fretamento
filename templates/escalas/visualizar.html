{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Visualizar Escala - {{ escala.data|date:"d/m/Y" }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabe√ßalho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0">
                        <i class="fas fa-calendar-check text-primary"></i>
                        Escala - {{ escala.data|date:"l, d/m/Y" }}
                    </h1>
                    <p class="text-muted">
                        Status: <span class="badge bg-{% if escala.etapa == 'ESTRUTURA' %}secondary{% elif escala.etapa == 'DADOS_PUXADOS' %}primary{% else %}success{% endif %}">{{ escala.get_etapa_display }}</span>
                        {% if escala.data_origem %}
                            | Dados de: {{ escala.data_origem|date:"d/m/Y" }}
                        {% endif %}
                    </p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{% url 'escalas:gerenciar_escalas' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    {% if escala.tem_dados %}
                        <a href="{% url 'escalas:exportar_escala' data=escala.data|date_br %}" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </a>
                    {% endif %}
                    {% if escala.etapa == 'DADOS_PUXADOS' %}
                        <form method="post" action="{% url 'escalas:gerenciar_escalas' %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="data" value="{{ escala.data|date_br }}">
                            <button type="submit" name="acao" value="otimizar" class="btn btn-warning">
                                <i class="fas fa-magic"></i> Otimizar Escala
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if not escala.tem_dados %}
        <!-- Estrutura Criada - Instru√ß√µes -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> Estrutura Criada com Sucesso!</h5>
                    <p class="mb-2">A estrutura b√°sica da escala foi criada. Agora voc√™ pode:</p>
                    <a href="{% url 'escalas:puxar_dados' data=escala.data|date_br %}" class="btn btn-primary">
                        <i class="fas fa-download"></i> Puxar Dados de uma Data
                    </a>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Instru√ß√µes Kanban -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <h6><i class="fas fa-info-circle"></i> Sistema Kanban Avan√ßado</h6>
                    <ul class="mb-0 small">
                        <li><strong>Mover entre vans:</strong> Arraste um servi√ßo para o espa√ßo vazio da outra van</li>
                        <li><strong>Agrupar servi√ßos:</strong> Arraste um servi√ßo e solte BEM NO CENTRO de outro cart√£o</li>
                        <li><strong>Indicadores visuais:</strong> Verde = Agrupar | Azul = Mover para van</li>
                        <li><strong>Desagrupar individual:</strong> Duplo clique no cart√£o OU clique no bot√£o <i class="fas fa-unlink text-danger"></i></li>
                        <li><strong>Desagrupar completo:</strong> Clique direito no cart√£o ‚Üí "Desagrupar grupo completo"</li>
                        <li><strong>Menu de contexto:</strong> Clique direito em qualquer cart√£o para mais op√ß√µes</li>
                        <li><strong>Filtrar:</strong> Use os filtros acima para encontrar servi√ßos espec√≠ficos</li>
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>

        <!-- Resumo Geral -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-users"></i> Total PAX
                        </h5>
                        <h3>{{ van1.total_pax|add:van2.total_pax }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-dollar-sign"></i> Valor Total
                        </h5>
                        <h3>R$ {{ van1.total_valor|add:van2.total_valor|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-layer-group"></i> Total Servi√ßos
                        </h5>
                        <h3>{{ total_servicos }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white {% if escala.esta_otimizada %}bg-success{% else %}bg-warning{% endif %}">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-magic"></i> Status
                        </h5>
                        <h6>{% if escala.esta_otimizada %}Otimizada{% else %}Distribui√ß√£o B√°sica{% endif %}</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-light">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-filter text-info"></i> Filtros de Busca
                            <button class="btn btn-sm btn-outline-secondary ms-2" id="clearFilters">
                                <i class="fas fa-times"></i> Limpar
                            </button>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Filtro por PAX -->
                            <div class="col-md-3">
                                <label for="filtro-pax" class="form-label small">
                                    <i class="fas fa-users text-primary"></i> PAX
                                </label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="filtro-pax-min" placeholder="Min" min="1">
                                    <span class="input-group-text">at√©</span>
                                    <input type="number" class="form-control" id="filtro-pax-max" placeholder="Max" min="1">
                                </div>
                            </div>
                            
                            <!-- Filtro por Servi√ßo -->
                            <div class="col-md-4">
                                <label for="filtro-servico" class="form-label small">
                                    <i class="fas fa-map-marker-alt text-danger"></i> Servi√ßo/Destino
                                </label>
                                <input type="text" class="form-control form-control-sm" id="filtro-servico" 
                                       placeholder="Digite para filtrar por servi√ßo...">
                            </div>
                            
                            <!-- Filtro por Local Pickup -->
                            <div class="col-md-3">
                                <label for="filtro-pickup" class="form-label small">
                                    <i class="fas fa-location-dot text-warning"></i> Local Pickup
                                </label>
                                <input type="text" class="form-control form-control-sm" id="filtro-pickup" 
                                       placeholder="Digite para filtrar pickup...">
                            </div>
                            
                            <!-- Filtro por Van -->
                            <div class="col-md-2">
                                <label for="filtro-van" class="form-label small">
                                    <i class="fas fa-van-shuttle text-info"></i> Van
                                </label>
                                <select class="form-select form-select-sm" id="filtro-van">
                                    <option value="">Todas</option>
                                    <option value="VAN1">Van 1</option>
                                    <option value="VAN2">Van 2</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Estat√≠sticas de Filtro -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted" id="filtro-stats">
                                        Mostrando todos os servi√ßos
                                    </small>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="filtro-pax-alto" title="PAX Alto (4+)">
                                            <i class="fas fa-users"></i> 4+
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="filtro-pax-medio" title="PAX M√©dio (7+)">
                                            <i class="fas fa-users"></i> 7+
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" id="filtro-pax-muito-alto" title="PAX Muito Alto (10+)">
                                            <i class="fas fa-users"></i> 10+
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" id="filtro-transfer" title="Transfers">
                                            <i class="fas fa-car"></i> Transfer
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="filtro-tour" title="Tours">
                                            <i class="fas fa-route"></i> Tour
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informa√ß√µes sobre Grupos (se existirem) -->
        {% if grupos_van1 or grupos_van2 %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-layer-group text-success"></i> 
                            Grupos de Servi√ßos
                            <small class="text-muted">({{ grupos_van1.count|add:grupos_van2.count }} grupos ativos)</small>
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row">
                            {% if grupos_van1 %}
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-2">Van 1</h6>
                                    {% for grupo in grupos_van1 %}
                                        <div class="card mb-2 border-success">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <strong>Grupo #{{ grupo.id }}</strong>
                                                        <small class="d-block text-muted">{{ grupo.cliente_principal }}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-success">{{ grupo.servicos.count }} servi√ßos</span>
                                                        <small class="d-block text-muted">{{ grupo.total_pax }} PAX</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if grupos_van2 %}
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-2">Van 2</h6>
                                    {% for grupo in grupos_van2 %}
                                        <div class="card mb-2 border-success">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <strong>Grupo #{{ grupo.id }}</strong>
                                                        <small class="d-block text-muted">{{ grupo.cliente_principal }}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-success">{{ grupo.servicos.count }} servi√ßos</span>
                                                        <small class="d-block text-muted">{{ grupo.total_pax }} PAX</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Interface Kanban - Van 1 e Van 2 -->
        <div class="row" id="kanban-container">
            <!-- Van 1 -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-van-shuttle"></i> Van 1
                            <span class="badge bg-light text-dark ms-2">{{ van1.total_pax }} PAX</span>
                            <span class="badge bg-light text-dark ms-1">R$ {{ van1.total_valor|floatformat:2 }}</span>
                            <span class="badge bg-light text-dark ms-1">{{ van1.count }} servi√ßos</span>
                        </h5>
                    </div>
                    <div class="card-body p-2" id="van1-container" data-van="VAN1">
                        {% for alocacao in van1.servicos %}
                            <div class="servico-card" 
                                 data-alocacao-id="{{ alocacao.id }}" 
                                 data-servico-id="{{ alocacao.servico.id }}"
                                 data-pax="{{ alocacao.servico.pax }}"
                                 data-servico="{{ alocacao.servico.servico|lower }}"
                                 data-pickup="{{ alocacao.servico.local_pickup|lower|default:'' }}"
                                 data-van="VAN1"
                                 draggable="true">
                                <div class="card mb-2 border {% if alocacao.grupo_info %}border-success{% endif %}" {% if alocacao.grupo_info %}title="Duplo clique para desagrupar | Clique direito para mais op√ß√µes"{% endif %}>
                                    {% if alocacao.grupo_info %}
                                        <div class="card-header p-1 bg-light">
                                            <small class="text-success">
                                                <i class="fas fa-layer-group"></i> 
                                                Grupo {{ alocacao.grupo_info.grupo.id }} 
                                                ({{ alocacao.grupo_info.grupo.servicos.count }} servi√ßos){% if alocacao.grupo_info.grupo.get_vendas_unicas %}<br><i class="fas fa-hashtag"></i> {{ alocacao.grupo_info.grupo.get_vendas_unicas }}{% endif %}
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm float-end py-0 px-1"
                                                        onclick="desagruparServico({{ alocacao.id }})"
                                                        title="Remover do grupo">
                                                    <i class="fas fa-unlink"></i>
                                                </button>
                                            </small>
                                        </div>
                                    {% endif %}
                                    <div class="card-body p-3">
                                        <!-- Cabe√ßalho do Servi√ßo -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">
                                                    <i class="fas fa-grip-vertical text-muted me-1"></i>
                                                    {% if alocacao.grupo_info %}
                                                        {{ alocacao.grupo_info.grupo.get_clientes_concatenados }}
                                                    {% else %}
                                                        {{ alocacao.servico.cliente }}
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-hashtag"></i> {{ alocacao.servico.numero_da_compra|default:"-" }}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                {% if alocacao.grupo_info %}
                                                    <span class="badge bg-primary">{{ alocacao.grupo_info.grupo.total_pax }} PAX</span>
                                                    <br><span class="badge bg-success">R$ {{ alocacao.grupo_info.grupo.total_valor|floatformat:2 }}</span>
                                                    <i class="fas fa-edit text-warning ms-1" style="cursor: pointer;" 
                                                       onclick="event.stopPropagation(); abrirModalTarifarios('{{ alocacao.servico.id }}', 'grupo', '{{ alocacao.grupo_info.grupo.id }}')"
                                                       title="Editar pre√ßo"></i>
                                                {% else %}
                                                    <span class="badge bg-primary">{{ alocacao.servico.pax }} PAX</span>
                                                    {% if alocacao.preco_calculado %}
                                                        <br><span class="badge bg-success">R$ {{ alocacao.preco_calculado|floatformat:2 }}</span>
                                                        <i class="fas fa-edit text-warning ms-1" style="cursor: pointer;" 
                                                           onclick="event.stopPropagation(); abrirModalTarifarios('{{ alocacao.servico.id }}', 'individual')"
                                                           title="Editar pre√ßo"></i>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Detalhes do Servi√ßo -->
                                        <div class="small">
                                            <div class="mb-1">
                                                <i class="fas fa-map-marker-alt text-danger"></i>
                                                <strong>Servi√ßo:</strong> {{ alocacao.servico.servico }}
                                            </div>
                                            
                                            {% if alocacao.grupo_info %}
                                                <!-- Mostrar informa√ß√µes consolidadas do grupo -->
                                                {% if alocacao.grupo_info.grupo.get_pickups_concatenados %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-location-dot text-warning"></i>
                                                        <strong>Pickup:</strong> {{ alocacao.grupo_info.grupo.get_pickups_concatenados }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="row g-1">
                                                    {% if alocacao.grupo_info.grupo.get_horarios_concatenados %}
                                                        <div class="col-6">
                                                            <i class="fas fa-clock text-info"></i>
                                                            {{ alocacao.grupo_info.grupo.get_horarios_concatenados }}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if alocacao.grupo_info.grupo.get_vendas_unicas %}
                                                        <div class="col-6">
                                                            <i class="fas fa-shopping-cart text-success"></i>
                                                            Vendas: {{ alocacao.grupo_info.grupo.get_vendas_unicas }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <!-- Mostrar informa√ß√µes individuais -->
                                                {% if alocacao.servico.local_pickup %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-location-dot text-warning"></i>
                                                        <strong>Pickup:</strong> {{ alocacao.servico.local_pickup }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="row g-1">
                                                    {% if alocacao.servico.horario %}
                                                        <div class="col-6">
                                                            <i class="fas fa-clock text-info"></i>
                                                            {{ alocacao.servico.horario|time:"H:i" }}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if alocacao.servico.numero_venda %}
                                                        <div class="col-6">
                                                            <i class="fas fa-shopping-cart text-success"></i>
                                                            Vendas: {{ alocacao.servico.numero_venda }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                            
                                            {% if alocacao.veiculo_recomendado %}
                                                <div class="mt-1">
                                                    <span class="badge bg-secondary">{{ alocacao.veiculo_recomendado }}</span>
                                                    {% if alocacao.lucratividade %}
                                                        <span class="badge bg-warning text-dark">Lucr.: {{ alocacao.lucratividade|floatformat:1 }}</span>
                                                    {% endif %}
                                                    {% if alocacao.automatica %}
                                                        <span class="badge bg-info">Auto</span>
                                                    {% else %}
                                                        <span class="badge bg-dark">Manual</span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center py-4 dropzone" data-van="VAN1">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">Van vazia</h6>
                                <p class="text-muted small">Arraste servi√ßos aqui</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Van 2 -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-van-shuttle"></i> Van 2
                            <span class="badge bg-light text-dark ms-2">{{ van2.total_pax }} PAX</span>
                            <span class="badge bg-light text-dark ms-1">R$ {{ van2.total_valor|floatformat:2 }}</span>
                            <span class="badge bg-light text-dark ms-1">{{ van2.count }} servi√ßos</span>
                        </h5>
                    </div>
                    <div class="card-body p-2" id="van2-container" data-van="VAN2">
                        {% for alocacao in van2.servicos %}
                            <div class="servico-card" 
                                 data-alocacao-id="{{ alocacao.id }}" 
                                 data-servico-id="{{ alocacao.servico.id }}"
                                 data-pax="{{ alocacao.servico.pax }}"
                                 data-servico="{{ alocacao.servico.servico|lower }}"
                                 data-pickup="{{ alocacao.servico.local_pickup|lower|default:'' }}"
                                 data-van="VAN2"
                                 draggable="true">
                                <div class="card mb-2 border {% if alocacao.grupo_info %}border-success{% endif %}" {% if alocacao.grupo_info %}title="Duplo clique para desagrupar | Clique direito para mais op√ß√µes"{% endif %}>
                                    {% if alocacao.grupo_info %}
                                        <div class="card-header p-1 bg-light">
                                            <small class="text-success">
                                                <i class="fas fa-layer-group"></i> 
                                                Grupo {{ alocacao.grupo_info.grupo.id }} 
                                                ({{ alocacao.grupo_info.grupo.servicos.count }} servi√ßos){% if alocacao.grupo_info.grupo.get_vendas_unicas %}<br><i class="fas fa-hashtag"></i> {{ alocacao.grupo_info.grupo.get_vendas_unicas }}{% endif %}
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm float-end py-0 px-1"
                                                        onclick="desagruparServico({{ alocacao.id }})"
                                                        title="Remover do grupo">
                                                    <i class="fas fa-unlink"></i>
                                                </button>
                                            </small>
                                        </div>
                                    {% endif %}
                                    <div class="card-body p-3">
                                        <!-- Cabe√ßalho do Servi√ßo -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">
                                                    <i class="fas fa-grip-vertical text-muted me-1"></i>
                                                    {% if alocacao.grupo_info %}
                                                        {{ alocacao.grupo_info.grupo.get_clientes_concatenados }}
                                                    {% else %}
                                                        {{ alocacao.servico.cliente }}
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-hashtag"></i> {{ alocacao.servico.numero_da_compra|default:"-" }}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                {% if alocacao.grupo_info %}
                                                    <span class="badge bg-primary">{{ alocacao.grupo_info.grupo.total_pax }} PAX</span>
                                                    <br><span class="badge bg-success">R$ {{ alocacao.grupo_info.grupo.total_valor|floatformat:2 }}</span>
                                                    <i class="fas fa-edit text-warning ms-1" style="cursor: pointer;" 
                                                       onclick="event.stopPropagation(); abrirModalTarifarios('{{ alocacao.servico.id }}', 'grupo', '{{ alocacao.grupo_info.grupo.id }}')"
                                                       title="Editar pre√ßo"></i>
                                                {% else %}
                                                    <span class="badge bg-primary">{{ alocacao.servico.pax }} PAX</span>
                                                    {% if alocacao.preco_calculado %}
                                                        <br><span class="badge bg-success">R$ {{ alocacao.preco_calculado|floatformat:2 }}</span>
                                                        <i class="fas fa-edit text-warning ms-1" style="cursor: pointer;" 
                                                           onclick="event.stopPropagation(); abrirModalTarifarios('{{ alocacao.servico.id }}', 'individual')"
                                                           title="Editar pre√ßo"></i>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Detalhes do Servi√ßo -->
                                        <div class="small">
                                            <div class="mb-1">
                                                <i class="fas fa-map-marker-alt text-danger"></i>
                                                <strong>Servi√ßo:</strong> {{ alocacao.servico.servico }}
                                            </div>
                                            
                                            {% if alocacao.grupo_info %}
                                                <!-- Mostrar informa√ß√µes consolidadas do grupo -->
                                                {% if alocacao.grupo_info.grupo.get_pickups_concatenados %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-location-dot text-warning"></i>
                                                        <strong>Pickup:</strong> {{ alocacao.grupo_info.grupo.get_pickups_concatenados }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="row g-1">
                                                    {% if alocacao.grupo_info.grupo.get_horarios_concatenados %}
                                                        <div class="col-6">
                                                            <i class="fas fa-clock text-info"></i>
                                                            {{ alocacao.grupo_info.grupo.get_horarios_concatenados }}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if alocacao.grupo_info.grupo.get_vendas_unicas %}
                                                        <div class="col-6">
                                                            <i class="fas fa-shopping-cart text-success"></i>
                                                            Vendas: {{ alocacao.grupo_info.grupo.get_vendas_unicas }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <!-- Mostrar informa√ß√µes individuais -->
                                                {% if alocacao.servico.local_pickup %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-location-dot text-warning"></i>
                                                        <strong>Pickup:</strong> {{ alocacao.servico.local_pickup }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="row g-1">
                                                    {% if alocacao.servico.horario %}
                                                        <div class="col-6">
                                                            <i class="fas fa-clock text-info"></i>
                                                            {{ alocacao.servico.horario|time:"H:i" }}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if alocacao.servico.numero_venda %}
                                                        <div class="col-6">
                                                            <i class="fas fa-shopping-cart text-success"></i>
                                                            Vendas: {{ alocacao.servico.numero_venda }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                            
                                            {% if alocacao.veiculo_recomendado %}
                                                <div class="mt-1">
                                                    <span class="badge bg-secondary">{{ alocacao.veiculo_recomendado }}</span>
                                                    {% if alocacao.lucratividade %}
                                                        <span class="badge bg-warning text-dark">Lucr.: {{ alocacao.lucratividade|floatformat:1 }}</span>
                                                    {% endif %}
                                                    {% if alocacao.automatica %}
                                                        <span class="badge bg-info">Auto</span>
                                                    {% else %}
                                                        <span class="badge bg-dark">Manual</span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center py-4 dropzone" data-van="VAN2">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">Van vazia</h6>
                                <p class="text-muted small">Arraste servi√ßos aqui</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- A√ß√µes -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex gap-2 justify-content-center flex-wrap">
                    <a href="{% url 'escalas:gerenciar_escalas' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar ao Gerenciamento
                    </a>

                    
                    {% if escala.tem_dados %}
                        <a href="{% url 'escalas:exportar_escala' data=escala.data|date_br %}" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Exportar para Excel
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- CSS para drag and drop -->
<style>
.servico-card {
    cursor: move;
    transition: all 0.3s ease;
}

.servico-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.servico-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.servico-card.drop-target {
    border: 3px solid #28a745;
    background-color: rgba(40, 167, 69, 0.1);
    transform: scale(1.02);
}

.servico-card.drop-target::before {
    content: "üîó AGRUPAR";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    z-index: 10;
    pointer-events: none;
}

.van-container.drag-over {
    border: 3px solid #007bff;
    background-color: rgba(0, 123, 255, 0.1);
}

.van-container.drag-over::before {
    content: "üì¶ MOVER PARA ESTA VAN";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #007bff;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    z-index: 10;
    pointer-events: none;
}

.dropzone {
    min-height: 100px;
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
}

.dropzone.drag-over {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.1);
}

#van1-container, #van2-container {
    min-height: 200px;
    position: relative;
}

.van-container {
    min-height: 400px;
    position: relative;
}

/* === ESTILOS PARA FILTROS === */
.btn.active {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}

.btn-outline-warning.active {
    background-color: var(--bs-warning);
    border-color: var(--bs-warning);
    color: var(--bs-dark);
}

.btn-outline-info.active {
    background-color: var(--bs-info);
    border-color: var(--bs-info);
    color: white;
}

.servico-card[style*="display: none"] {
    transition: opacity 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
}

#filtro-stats strong {
    color: var(--bs-primary);
}

/* Anima√ß√£o suave para filtros */
.servico-card {
    transition: all 0.3s ease;
}

/* Estilos para menu de contexto */
.menu-item {
    padding: 8px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.menu-item:hover {
    background-color: #f8f9fa;
}

.menu-item:last-child {
    border-bottom: none;
}

.menu-item.disabled {
    color: #6c757d;
    cursor: not-allowed;
}

.menu-item.disabled:hover {
    background-color: transparent;
}

.menu-item-hint {
    padding: 5px 15px;
    font-size: 11px;
    color: #6c757d;
    font-style: italic;
    background-color: #f8f9fa;
}

/* Melhorar indica√ß√£o visual de grupos */
.servico-card .border-success {
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
}

.servico-card:hover .border-success {
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.4);
}

/* Tooltip para duplo clique */
.servico-card[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 5px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
}
</style>

<!-- JavaScript para funcionalidade Kanban -->
<script>
// Fun√ß√£o global para mostrar mensagens
function showMessage(text, type) {
    // Remover mensagem anterior se existir
    const existingAlert = document.querySelector('.alert-message');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show alert-message" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            ${text}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto-remover ap√≥s 3 segundos
    setTimeout(() => {
        const alert = document.querySelector('.alert-message');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    const servicoCards = document.querySelectorAll('.servico-card');
    const containers = document.querySelectorAll('[data-van]');
    
    // Configurar drag and drop para cada cart√£o de servi√ßo
    servicoCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragover', handleCardDragOver);
        card.addEventListener('drop', handleCardDrop);
        
        // Adicionar duplo clique para desagrupar
        card.addEventListener('dblclick', handleDoubleClick);
        
        // Adicionar menu de contexto
        card.addEventListener('contextmenu', handleRightClick);
        
        // Adicionar clique simples para abrir modal de detalhes
        card.addEventListener('click', handleCardClick);
    });
    
    // Configurar drop zones
    containers.forEach(container => {
        container.addEventListener('dragover', handleDragOver);
        container.addEventListener('drop', handleDrop);
        container.addEventListener('dragenter', handleDragEnter);
        container.addEventListener('dragleave', handleDragLeave);
    });
    
    let draggedElement = null;
    
    function handleDragStart(e) {
        this.classList.add('dragging');
        draggedElement = this;
        e.dataTransfer.setData('text/plain', this.dataset.alocacaoId);
        e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        draggedElement = null;
        // Remover highlights de todos os cards
        document.querySelectorAll('.servico-card').forEach(card => {
            card.classList.remove('drop-target');
        });
    }
    
    function handleCardDragOver(e) {
        e.preventDefault();
        if (draggedElement && draggedElement !== this) {
            // S√≥ adiciona highlight se realmente sobre o cart√£o
            const rect = this.getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // Verifica se est√° realmente sobre o cart√£o (com margem de precis√£o)
            if (mouseX >= rect.left + 10 && mouseX <= rect.right - 10 &&
                mouseY >= rect.top + 10 && mouseY <= rect.bottom - 10) {
                this.classList.add('drop-target');
                e.dataTransfer.dropEffect = 'copy'; // Indica agrupamento
            } else {
                this.classList.remove('drop-target');
                e.dataTransfer.dropEffect = 'move'; // Indica movimenta√ß√£o
            }
        }
    }
    
    function handleCardDrop(e) {
        e.preventDefault();
        
        this.classList.remove('drop-target');
        
        if (draggedElement && draggedElement !== this) {
            // Verifica se est√° realmente sobre o cart√£o para agrupar
            const rect = this.getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // S√≥ agrupa se solto BEM NO CENTRO do cart√£o
            if (mouseX >= rect.left + 20 && mouseX <= rect.right - 20 &&
                mouseY >= rect.top + 20 && mouseY <= rect.bottom - 20) {
                
                e.stopPropagation(); // Impede movimenta√ß√£o
                
                // Agrupar servi√ßos
                const alocacaoOrigemId = draggedElement.dataset.alocacaoId;
                const alocacaoDestinoId = this.dataset.alocacaoId;
                
                fetch('{% url "escalas:agrupar_servicos" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        alocacao_origem_id: alocacaoOrigemId,
                        alocacao_destino_id: alocacaoDestinoId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('Servi√ßos agrupados com sucesso!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage('Erro ao agrupar servi√ßos: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showMessage('Erro ao agrupar servi√ßos', 'error');
                });
            }
            // Se n√£o est√° bem no centro, deixa que o handleDrop do container processe a movimenta√ß√£o
        }
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    function handleDragEnter(e) {
        e.preventDefault();
        if (!e.target.closest('.servico-card')) {
            this.classList.add('drag-over');
        }
    }
    
    function handleDragLeave(e) {
        // S√≥ remove se realmente saiu do container
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('drag-over');
        }
    }
    
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const alocacaoId = e.dataTransfer.getData('text/plain');
        const novaVan = this.dataset.van;
        
        if (!draggedElement) {
            return;
        }
        
        // Verificar se a van atual √© diferente da nova van
        const vanAtual = draggedElement.dataset.van;
        if (vanAtual === novaVan) {
            // Mesma van - s√≥ reorganizar se necess√°rio
            showMessage('Servi√ßo j√° est√° nesta van', 'info');
            return;
        }
        
        // Mover o servi√ßo via AJAX
        fetch('{% url "escalas:mover_servico" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                alocacao_id: alocacaoId,
                nova_van: novaVan,
                nova_posicao: 0
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const mensagem = data.message || `Servi√ßo movido para ${novaVan === 'VAN1' ? 'Van 1' : 'Van 2'}!`;
                showMessage(mensagem, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('Erro ao mover servi√ßo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showMessage('Erro ao mover servi√ßo', 'error');
        });
    }
    
    // Duplo clique para desagrupar
    function handleDoubleClick(e) {
        e.preventDefault();
        const alocacaoId = this.dataset.alocacaoId;
        const isGrouped = this.querySelector('.border-success');
        
        if (isGrouped) {
            desagruparServico(alocacaoId, 'Duplo clique para desagrupar detectado!');
        }
    }
    
    // Clique direito para menu de contexto
    function handleRightClick(e) {
        e.preventDefault();
        const alocacaoId = this.dataset.alocacaoId;
        const isGrouped = this.querySelector('.border-success');
        
        // Remover menu anterior se existir
        const existingMenu = document.querySelector('.context-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
        
        // Criar menu de contexto
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.cssText = `
            position: fixed;
            top: ${e.clientY}px;
            left: ${e.clientX}px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 9999;
            min-width: 200px;
        `;
        
        if (isGrouped) {
            menu.innerHTML = `
                <div class="menu-item" onclick="desagruparServico(${alocacaoId}, 'Removido via menu de contexto')">
                    <i class="fas fa-unlink text-danger"></i> Remover do grupo
                </div>
                <div class="menu-item" onclick="desagruparGrupoCompleto(${alocacaoId})">
                    <i class="fas fa-object-ungroup text-warning"></i> Desagrupar grupo completo
                </div>
            `;
        } else {
            menu.innerHTML = `
                <div class="menu-item disabled">
                    <i class="fas fa-info-circle text-muted"></i> Servi√ßo n√£o est√° agrupado
                </div>
                <div class="menu-item-hint">
                    Dica: Arraste sobre outro servi√ßo para agrupar
                </div>
            `;
        }
        
        document.body.appendChild(menu);
        
        // Remover menu ao clicar fora
        setTimeout(() => {
            document.addEventListener('click', function removeMenu() {
                menu.remove();
                document.removeEventListener('click', removeMenu);
            });
        }, 100);
    }
    
    // Clique simples para abrir modal de detalhes
    function handleCardClick(e) {
        // Prevenir se estiver arrastando ou em contexto menu
        if (e.ctrlKey || e.shiftKey || e.detail > 1) {
            return;
        }
        
        // N√£o abrir modal se clicou em bot√£o espec√≠fico ou √≠cone de edi√ß√£o
        if (e.target.closest('button') || e.target.closest('.btn') || e.target.classList.contains('fa-edit')) {
            return;
        }
        
        const alocacaoId = this.dataset.alocacaoId;
        
        // Verificar se este servi√ßo est√° em um grupo
        const isGrouped = this.querySelector('.border-success') || this.closest('.grupo-servicos');
        
        if (isGrouped) {
            // Abrir modal de grupo
            abrirModalGrupo(alocacaoId);
        } else {
            // Abrir modal de servi√ßo individual
            abrirModalDetalhes(alocacaoId);
        }
    }
});

// Fun√ß√£o para abrir modal e carregar dados
function abrirModalDetalhes(alocacaoId) {
    fetch(`{% url "escalas:detalhes_servico" %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            preencherModalDetalhes(data.servico, data.alocacao);
            const modal = new bootstrap.Modal(document.getElementById('modalDetalhesServico'));
            modal.show();
        } else {
            showMessage('Erro ao carregar detalhes: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao carregar detalhes do servi√ßo', 'error');
    });
}

// Fun√ß√£o para abrir modal de grupo e carregar dados
function abrirModalGrupo(alocacaoId) {
    fetch(`{% url "escalas:detalhes_grupo" %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            preencherModalGrupo(data.grupo, data.servicos);
            const modal = new bootstrap.Modal(document.getElementById('modalDetalhesGrupo'));
            modal.show();
        } else {
            showMessage('Erro ao carregar detalhes do grupo: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao carregar detalhes do grupo', 'error');
    });
}

// Fun√ß√£o para preencher o modal de grupo com dados
function preencherModalGrupo(grupo, servicos) {
    // Informa√ß√µes b√°sicas do grupo
    document.getElementById('editGrupoCliente').value = grupo.cliente_principal || '';
    document.getElementById('editGrupoServico').value = grupo.servico_principal || '';
    document.getElementById('editGrupoPickup').value = grupo.local_pickup_principal || '';
    document.getElementById('editGrupoVan').value = grupo.van || '';
    document.getElementById('editGrupoTotalPax').value = grupo.total_pax || 0;
    document.getElementById('editGrupoTotal').value = grupo.total_valor || 0;
    document.getElementById('editGrupoId').value = grupo.id;
    
    // Preencher lista de servi√ßos
    const listaContainer = document.getElementById('listaServicosGrupo');
    listaContainer.innerHTML = '';
    
    servicos.forEach((servico, index) => {
        const servicoHtml = `
            <div class="border-bottom pb-2 mb-2" data-servico-id="${servico.alocacao_id}">
                <div class="row">
                    <div class="col-md-6">
                        <strong>${servico.cliente}</strong>
                        <br><small class="text-muted">${servico.servico}</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <span class="badge bg-info">${servico.pax} PAX</span>
                    </div>
                    <div class="col-md-3 text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="removerServicoDoGrupo(${servico.alocacao_id})">
                            <i class="fas fa-unlink"></i> Remover
                        </button>
                    </div>
                </div>
                ${servico.local_pickup ? `<small class="text-success"><i class="fas fa-location-dot"></i> ${servico.local_pickup}</small>` : ''}
            </div>
        `;
        listaContainer.insertAdjacentHTML('beforeend', servicoHtml);
    });
    
    // Atualizar t√≠tulo do modal
    document.getElementById('modalGrupoLabel').innerHTML = 
        `<i class="fas fa-layer-group"></i> Grupo: ${grupo.cliente_principal} (${servicos.length} servi√ßos)`;
}

// Fun√ß√£o para preencher o modal com dados
function preencherModalDetalhes(servico, alocacao) {
    // Informa√ß√µes b√°sicas
    document.getElementById('editCliente').value = servico.cliente || '';
    document.getElementById('editPax').value = servico.pax || '';
    document.getElementById('editServico').value = servico.servico || '';
    document.getElementById('editPickup').value = servico.local_pickup || '';
    
    // Data e hor√°rio
    document.getElementById('editHorario').value = servico.horario || '';
    document.getElementById('editDataServico').value = servico.data_do_servico || '';
    
    // Informa√ß√µes da venda
    document.getElementById('editNumeroVenda').value = servico.numero_venda || '';
    
    // Caracter√≠sticas do servi√ßo
    document.getElementById('editTipo').value = servico.tipo || 'OUTRO';
    document.getElementById('editDirecao').value = servico.direcao || 'N/A';
    document.getElementById('editAeroporto').value = servico.aeroporto || 'N/A';
    document.getElementById('editRegiao').value = servico.regiao || 'N/A';
    
    // Caracter√≠sticas especiais
    document.getElementById('editEhRegular').checked = servico.eh_regular || false;
    document.getElementById('editEhPrioritario').checked = servico.eh_prioritario || false;
    
    // Van atual
    document.getElementById('editVan').value = alocacao.van || '';
    
    // IDs para salvamento
    document.getElementById('editServicoId').value = servico.id;
    document.getElementById('editAlocacaoId').value = alocacao.id;
    
    // Atualizar t√≠tulo do modal
    document.getElementById('modalDetalhesLabel').innerHTML = 
        `<i class="fas fa-edit"></i> Editando: ${servico.cliente} - ${servico.pax} PAX`;
}

// Event listeners para o modal
document.addEventListener('DOMContentLoaded', function() {
    // Salvar edi√ß√µes de servi√ßo individual
    document.getElementById('btnSalvarEdicao').addEventListener('click', function() {
        salvarEdicoesServico();
    });
    
    // Excluir servi√ßo
    document.getElementById('btnExcluirServico').addEventListener('click', function() {
        excluirServico();
    });
    
    // Salvar edi√ß√µes de grupo
    document.getElementById('btnSalvarGrupo').addEventListener('click', function() {
        salvarEdicoesGrupo();
    });
    
    // Desagrupar todos os servi√ßos
    document.getElementById('btnDesagruparTodos').addEventListener('click', function() {
        desagruparTodosServicos();
    });
});

// Fun√ß√£o para salvar as edi√ß√µes
function salvarEdicoesServico() {
    const formData = new FormData(document.getElementById('formEditarServico'));
    const data = Object.fromEntries(formData);
    
    fetch('{% url "escalas:salvar_edicao_servico" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Servi√ßo atualizado com sucesso!', 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesServico'));
            modal.hide();
            // Recarregar p√°gina para mostrar mudan√ßas
            setTimeout(() => window.location.href = window.location.href, 1000);
        } else {
            showMessage('Erro ao salvar: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao salvar altera√ß√µes', 'error');
    });
}

// Fun√ß√£o para excluir um servi√ßo
function excluirServico() {
    const alocacaoId = document.getElementById('editAlocacaoId').value;
    const cliente = document.getElementById('editCliente').value;
    const pax = document.getElementById('editPax').value;
    
    if (!confirm(`Tem certeza que deseja EXCLUIR o servi√ßo "${cliente}" (${pax} PAX)?\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
    }
    
    fetch('{% url "escalas:excluir_servico" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesServico'));
            modal.hide();
            // Recarregar p√°gina para mostrar mudan√ßas
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro ao excluir servi√ßo: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao excluir servi√ßo', 'error');
    });
}

// Fun√ß√£o para salvar as edi√ß√µes de grupo
function salvarEdicoesGrupo() {
    const formData = new FormData(document.getElementById('formEditarGrupo'));
    const data = Object.fromEntries(formData);
    
    fetch('{% url "escalas:salvar_edicao_grupo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Grupo atualizado com sucesso!', 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesGrupo'));
            modal.hide();
            // Recarregar p√°gina para mostrar mudan√ßas
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro ao salvar grupo: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao salvar altera√ß√µes do grupo', 'error');
    });
}

// Fun√ß√£o para desagrupar todos os servi√ßos do grupo
function desagruparTodosServicos() {
    if (!confirm('Deseja desagrupar TODOS os servi√ßos deste grupo? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
    }
    
    const grupoId = document.getElementById('editGrupoId').value;
    
    // Usar primeira aloca√ß√£o do grupo para a chamada
    const primeiraAlocacao = document.querySelector('#listaServicosGrupo [data-servico-id]');
    if (!primeiraAlocacao) {
        showMessage('Erro: N√£o foi poss√≠vel identificar as aloca√ß√µes do grupo', 'error');
        return;
    }
    
    const alocacaoId = primeiraAlocacao.dataset.servicoId;
    
    fetch('{% url "escalas:desagrupar_grupo_completo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Grupo desagrupado com sucesso!', 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesGrupo'));
            modal.hide();
            // Recarregar p√°gina para mostrar mudan√ßas
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro ao desagrupar: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao desagrupar grupo', 'error');
    });
}

// Fun√ß√£o para desagrupar servi√ßo
function desagruparServico(alocacaoId, customMessage = null) {
    const message = customMessage || 'Deseja remover este servi√ßo do grupo?';
    if (!confirm(message)) {
        return;
    }
    
    fetch('{% url "escalas:desagrupar_servico" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Servi√ßo removido do grupo!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao desagrupar servi√ßo', 'error');
    });
}

// Fun√ß√£o para desagrupar grupo completo
function desagruparGrupoCompleto(alocacaoId) {
    if (!confirm('Deseja desagrupar TODOS os servi√ßos deste grupo?')) {
        return;
    }
    
    fetch('{% url "escalas:desagrupar_grupo_completo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            alocacao_id: alocacaoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Grupo desagrupado completamente!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao desagrupar grupo', 'error');
    });
}

// ===== SISTEMA DE FILTROS =====
document.addEventListener('DOMContentLoaded', function() {
    // Elementos dos filtros
    const filtroPaxMin = document.getElementById('filtro-pax-min');
    const filtroPaxMax = document.getElementById('filtro-pax-max');
    const filtroServico = document.getElementById('filtro-servico');
    const filtroPickup = document.getElementById('filtro-pickup');
    const filtroVan = document.getElementById('filtro-van');
    const clearFilters = document.getElementById('clearFilters');
    const filtroStats = document.getElementById('filtro-stats');
    
    // Bot√µes de filtro r√°pido
    const filtroPaxAlto = document.getElementById('filtro-pax-alto');
    const filtroPaxMedio = document.getElementById('filtro-pax-medio');
    const filtroPaxMuitoAlto = document.getElementById('filtro-pax-muito-alto');
    const filtroTransfer = document.getElementById('filtro-transfer');
    const filtroTour = document.getElementById('filtro-tour');
    
    // Todos os cards de servi√ßo
    const servicoCards = document.querySelectorAll('.servico-card');
    
    // Fun√ß√£o para aplicar filtros
    function aplicarFiltros() {
        const paxMin = parseInt(filtroPaxMin.value) || 0;
        const paxMax = parseInt(filtroPaxMax.value) || 999;
        const servicoTexto = filtroServico.value.toLowerCase();
        const pickupTexto = filtroPickup.value.toLowerCase();
        const vanSelecionada = filtroVan.value;
        
        let servicosVisiveis = 0;
        let paxVisivel = 0;
        let van1Visiveis = 0;
        let van2Visiveis = 0;
        
        servicoCards.forEach(card => {
            const pax = parseInt(card.dataset.pax);
            const servico = card.dataset.servico;
            const pickup = card.dataset.pickup;
            const van = card.dataset.van;
            
            // Verificar filtros
            const passaPax = pax >= paxMin && pax <= paxMax;
            const passaServico = !servicoTexto || servico.includes(servicoTexto);
            const passaPickup = !pickupTexto || pickup.includes(pickupTexto);
            const passaVan = !vanSelecionada || van === vanSelecionada;
            
            // Mostrar/ocultar card
            if (passaPax && passaServico && passaPickup && passaVan) {
                card.style.display = 'block';
                servicosVisiveis++;
                paxVisivel += pax;
                if (van === 'VAN1') van1Visiveis++;
                else van2Visiveis++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Atualizar estat√≠sticas
        atualizarEstatisticas(servicosVisiveis, paxVisivel, van1Visiveis, van2Visiveis);
    }
    
    // Fun√ß√£o para atualizar estat√≠sticas
    function atualizarEstatisticas(servicos, pax, van1, van2) {
        const total = servicoCards.length;
        if (servicos === total) {
            filtroStats.textContent = `Mostrando todos os ${servicos} servi√ßos (${pax} PAX)`;
        } else {
            filtroStats.innerHTML = `
                Mostrando <strong>${servicos}</strong> de ${total} servi√ßos (${pax} PAX) 
                | Van 1: ${van1} | Van 2: ${van2}
            `;
        }
    }
    
    // Fun√ß√£o para limpar filtros
    function limparFiltros() {
        filtroPaxMin.value = '';
        filtroPaxMax.value = '';
        filtroServico.value = '';
        filtroPickup.value = '';
        filtroVan.value = '';
        
        // Remover classes ativas dos bot√µes
        document.querySelectorAll('.btn-outline-primary.active, .btn-outline-warning.active, .btn-outline-info.active')
                .forEach(btn => btn.classList.remove('active'));
        
        aplicarFiltros();
    }
    
    // Event listeners para filtros
    filtroPaxMin.addEventListener('input', aplicarFiltros);
    filtroPaxMax.addEventListener('input', aplicarFiltros);
    filtroServico.addEventListener('input', aplicarFiltros);
    filtroPickup.addEventListener('input', aplicarFiltros);
    filtroVan.addEventListener('change', aplicarFiltros);
    clearFilters.addEventListener('click', limparFiltros);
    
    // Filtros r√°pidos
    filtroPaxAlto.addEventListener('click', function() {
        limparFiltros();
        filtroPaxMin.value = '4';
        this.classList.add('active');
        aplicarFiltros();
    });
    
    filtroPaxMedio.addEventListener('click', function() {
        limparFiltros();
        filtroPaxMin.value = '7';
        this.classList.add('active');
        aplicarFiltros();
    });
    
    filtroPaxMuitoAlto.addEventListener('click', function() {
        limparFiltros();
        filtroPaxMin.value = '10';
        this.classList.add('active');
        aplicarFiltros();
    });
    
    filtroTransfer.addEventListener('click', function() {
        limparFiltros();
        filtroServico.value = 'transfer';
        this.classList.add('active');
        aplicarFiltros();
    });
    
    filtroTour.addEventListener('click', function() {
        limparFiltros();
        filtroServico.value = 'tour';
        this.classList.add('active');
        aplicarFiltros();
    });
    
    // Aplicar filtros inicial
    aplicarFiltros();
});

// Fun√ß√£o para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fun√ß√£o para abrir modal de tarif√°rios
function abrirModalTarifarios(servicoId, tipo, grupoId = null) {
    // Armazenar informa√ß√µes do servi√ßo selecionado
    document.getElementById('servicoIdSelecionado').value = servicoId;
    document.getElementById('tipoSelecionado').value = tipo;
    if (grupoId) {
        document.getElementById('grupoIdSelecionado').value = grupoId;
    }
    
    // Carregar dados dos tarif√°rios
    carregarTarifarios();
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalTarifarios'));
    modal.show();
}

// Fun√ß√£o para carregar dados dos tarif√°rios
function carregarTarifarios() {
    fetch('/escalas/api/tarifarios/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                preencherTabelaJW(data.tarifario_jw);
                preencherTabelaMotoristas(data.tarifario_motoristas);
            } else {
                console.error('Erro ao carregar tarif√°rios:', data.error);
            }
        })
        .catch(error => {
            console.error('Erro na requisi√ß√£o:', error);
        });
}

// Fun√ß√£o para preencher tabela do tarif√°rio JW
function preencherTabelaJW(tarifarioJW) {
    const tbody = document.getElementById('tabelaJW');
    tbody.innerHTML = '';
    
    const veiculos = ['Executivo', 'Van 15 lugares', 'Van 18 lugares', 'Micro', '√înibus'];
    
    for (const [servico, precos] of Object.entries(tarifarioJW)) {
        const row = document.createElement('tr');
        
        // Coluna do servi√ßo
        const cellServico = document.createElement('td');
        cellServico.innerHTML = `<strong>${servico}</strong>`;
        row.appendChild(cellServico);
        
        // Colunas dos ve√≠culos
        veiculos.forEach(veiculo => {
            const cell = document.createElement('td');
            if (precos[veiculo]) {
                const preco = parseFloat(precos[veiculo]);
                
                const badge = document.createElement('span');
                badge.className = 'badge bg-success';
                badge.style.cursor = 'pointer';
                badge.textContent = `R$ ${preco.toFixed(2)}`;
                badge.addEventListener('click', function() {
                    aplicarPrecoSelecionado(preco, servico, veiculo);
                });
                
                cell.appendChild(badge);
            } else {
                cell.innerHTML = '<span class="badge bg-secondary">N/A</span>';
            }
            row.appendChild(cell);
        });
        
        tbody.appendChild(row);
    }
}

// Fun√ß√£o para preencher tabela do tarif√°rio de motoristas
function preencherTabelaMotoristas(tarifarioMotoristas) {
    const tbody = document.getElementById('tabelaMotoristas');
    tbody.innerHTML = '';
    
    for (const [servico, preco] of Object.entries(tarifarioMotoristas)) {
        const row = document.createElement('tr');
        
        // Criar c√©lulas
        const cellServico = document.createElement('td');
        cellServico.innerHTML = `<strong>${servico}</strong>`;
        
        const cellPreco = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary';
        badge.style.cursor = 'pointer';
        badge.textContent = `R$ ${preco.toFixed(2)}`;
        badge.addEventListener('click', function() {
            aplicarPrecoSelecionado(preco, servico, 'Motorista');
        });
        cellPreco.appendChild(badge);
        
        const cellObs = document.createElement('td');
        cellObs.innerHTML = '<small class="text-muted">Multiplicado pelo n√∫mero de venda</small>';
        
        row.appendChild(cellServico);
        row.appendChild(cellPreco);
        row.appendChild(cellObs);
        
        tbody.appendChild(row);
    }
}

// Fun√ß√£o para aplicar pre√ßo selecionado
function aplicarPrecoSelecionado(preco, servicoOrigem, veiculo) {
    console.log('üéØ aplicarPrecoSelecionado chamada:', { preco, servicoOrigem, veiculo });
    
    const servicoId = document.getElementById('servicoIdSelecionado').value;
    const tipo = document.getElementById('tipoSelecionado').value;
    const grupoId = document.getElementById('grupoIdSelecionado').value;
    
    console.log('üìä Dados do servi√ßo:', { servicoId, tipo, grupoId });
    
    if (!servicoId) {
        console.error('servicoId n√£o encontrado!');
        alert('Erro: ID do servi√ßo n√£o encontrado. Tente fechar e abrir o modal novamente.');
        return;
    }
    
    // Verificar se existe Bootstrap
    if (!window.bootstrap) {
        console.error('Bootstrap n√£o dispon√≠vel!');
        alert('Erro: Bootstrap n√£o carregado. Recarregue a p√°gina.');
        return;
    }
    
    // Armazenar dados para confirma√ß√£o
    window.precoParaConfirmar = {
        preco: preco,
        servicoOrigem: servicoOrigem,
        veiculo: veiculo,
        servicoId: servicoId,
        tipo: tipo,
        grupoId: grupoId
    };
    
    // Verificar se modal de confirma√ß√£o existe primeiro
    const modalConfirmacaoEl = document.getElementById('modalConfirmacaoPreco');
    if (!modalConfirmacaoEl) {
        console.error('‚ùå Modal de confirma√ß√£o n√£o encontrado no DOM!');
        alert('Erro: Modal de confirma√ß√£o n√£o encontrado. Verifique se a p√°gina carregou completamente.');
        return;
    }
    
    // Fechar modal de tarif√°rios primeiro
    const modalTarifarios = bootstrap.Modal.getInstance(document.getElementById('modalTarifarios'));
    if (modalTarifarios) {
        console.log('ÔøΩ Fechando modal de tarif√°rios...');
        modalTarifarios.hide();
    }
    
    // Fun√ß√£o para preencher modal quando estiver pronto
    function preencherModalConfirmacao() {
        console.log('üìù Tentando preencher modal de confirma√ß√£o...');
        
        // Estrat√©gia m√∫ltipla para encontrar elementos
        let precoEl = null;
        let origemEl = null;
        
        // Estrat√©gia 1: IDs diretos
        precoEl = document.getElementById('precoConfirmacao');
        origemEl = document.getElementById('origemConfirmacao');
        console.log('üîç Estrat√©gia 1 - IDs diretos:', {precoEl, origemEl});
        
        // Estrat√©gia 2: Buscar dentro do modal
        if (!precoEl || !origemEl) {
            precoEl = precoEl || modalConfirmacaoEl.querySelector('#precoConfirmacao');
            origemEl = origemEl || modalConfirmacaoEl.querySelector('#origemConfirmacao');
            console.log('üîç Estrat√©gia 2 - Dentro do modal:', {precoEl, origemEl});
        }
        
        // Estrat√©gia 3: Buscar por classes e contexto
        if (!precoEl) {
            precoEl = modalConfirmacaoEl.querySelector('.badge.bg-success');
            console.log('üîç Estrat√©gia 3 - Badge verde encontrado:', precoEl);
        }
        
        if (!origemEl) {
            // Buscar span que n√£o seja badge
            const spans = Array.from(modalConfirmacaoEl.querySelectorAll('span'));
            origemEl = spans.find(span => 
                !span.classList.contains('badge') && 
                span.textContent.trim() !== '' &&
                !span.textContent.includes('R$')
            );
            console.log('üîç Estrat√©gia 3 - Span para origem encontrado:', origemEl);
        }
        
        // Estrat√©gia 4: For√ßar cria√ß√£o com base na estrutura existente
        if (!precoEl || !origemEl) {
            console.warn('‚ö†Ô∏è Elementos n√£o encontrados, analisando estrutura...');
            console.log('üîç HTML completo do modal:', modalConfirmacaoEl.innerHTML);
            
            // Tentar encontrar qualquer estrutura que possa ser usada
            const rows = modalConfirmacaoEl.querySelectorAll('.row');
            console.log('üîç Rows encontradas:', rows.length);
            
            rows.forEach((row, index) => {
                console.log(`üîç Row ${index}:`, row.innerHTML);
            });
        }
        
        console.log('üîç Elementos finais ap√≥s todas as estrat√©gias:', { precoEl, origemEl });
        
        if (!precoEl || !origemEl) {
            console.error('‚ùå Ainda n√£o foi poss√≠vel encontrar os elementos!');
            console.log('üîç Estrutura do modal:', modalConfirmacaoEl.innerHTML);
            
            // √öltima tentativa: recriar elementos do zero
            const alertDiv = modalConfirmacaoEl.querySelector('.alert.alert-info');
            console.log('üîç Alert div encontrado:', alertDiv);
            
            if (alertDiv) {
                console.log('‚úÖ Recriando estrutura do modal...');
                alertDiv.innerHTML = `
                    <div class="row">
                        <div class="col-6"><strong>Pre√ßo:</strong></div>
                        <div class="col-6">
                            <span class="badge bg-success fs-6" id="precoConfirmacao">R$ ${preco.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6"><strong>Origem:</strong></div>
                        <div class="col-6">
                            <span id="origemConfirmacao">${servicoOrigem} - ${veiculo}</span>
                        </div>
                    </div>
                `;
                console.log('‚úÖ Elementos recriados com sucesso!');
                return true;
            } else {
                console.error('‚ùå N√£o foi poss√≠vel encontrar div.alert.alert-info');
                
                // Buscar qualquer div que possa servir
                const modalBody = modalConfirmacaoEl.querySelector('.modal-body');
                console.log('üîç Modal body encontrado:', modalBody);
                
                if (modalBody) {
                    // Encontrar onde inserir o conte√∫do
                    let targetDiv = modalBody.querySelector('.alert') || modalBody;
                    
                    // Se n√£o houver alert, criar um
                    if (!modalBody.querySelector('.alert')) {
                        console.log('üìù Criando estrutura alert do zero...');
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-info mt-3';
                        
                        // Inserir depois do h5 que cont√©m "Aplicar o seguinte pre√ßo?"
                        const h5 = modalBody.querySelector('h5');
                        if (h5) {
                            h5.insertAdjacentElement('afterend', alertDiv);
                            targetDiv = alertDiv;
                        } else {
                            modalBody.appendChild(alertDiv);
                            targetDiv = alertDiv;
                        }
                    }
                    
                    targetDiv.innerHTML = `
                        <div class="row">
                            <div class="col-6"><strong>Pre√ßo:</strong></div>
                            <div class="col-6">
                                <span class="badge bg-success fs-6" id="precoConfirmacao">R$ ${preco.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6"><strong>Origem:</strong></div>
                            <div class="col-6">
                                <span id="origemConfirmacao">${servicoOrigem} - ${veiculo}</span>
                            </div>
                        </div>
                    `;
                    console.log('‚úÖ Estrutura criada dinamicamente!');
                    return true;
                } else {
                    console.error('‚ùå N√£o foi poss√≠vel encontrar .modal-body');
                    alert('Erro cr√≠tico: Modal n√£o possui estrutura esperada. Recarregue a p√°gina.');
                    return false;
                }
            }
        }
        
        // Preencher elementos normalmente
        if (precoEl && origemEl) {
            // Garantir que os elementos tenham IDs corretos
            if (!precoEl.id) precoEl.id = 'precoConfirmacao';
            if (!origemEl.id) origemEl.id = 'origemConfirmacao';
            
            precoEl.textContent = `R$ ${preco.toFixed(2)}`;
            origemEl.textContent = `${servicoOrigem} - ${veiculo}`;
            console.log('‚úÖ Elementos preenchidos com sucesso!');
            return true;
        } else {
            console.warn('‚ö†Ô∏è Um ou ambos elementos ainda s√£o null, tentando recria√ß√£o...');
            return false;
        }
    }
    
    // Abrir modal de confirma√ß√£o e preencher
    setTimeout(() => {
        console.log('‚è±Ô∏è Abrindo modal de confirma√ß√£o...');
        
        try {
            const modalConfirmacao = new bootstrap.Modal(modalConfirmacaoEl);
            
            // Aguardar o modal ser mostrado completamente
            modalConfirmacaoEl.addEventListener('shown.bs.modal', function preencherAposAbrir() {
                console.log('üéâ Modal de confirma√ß√£o totalmente carregado!');
                preencherModalConfirmacao();
                // Remover listener para evitar duplica√ß√£o
                modalConfirmacaoEl.removeEventListener('shown.bs.modal', preencherAposAbrir);
            });
            
            modalConfirmacao.show();
            console.log('‚úÖ Modal de confirma√ß√£o disparado para abertura');
            
        } catch (error) {
            console.error('‚ùå Erro ao abrir modal de confirma√ß√£o:', error);
            alert('Erro ao abrir modal de confirma√ß√£o: ' + error.message);
        }
    }, 300);
}

// Fun√ß√£o para confirmar e aplicar o pre√ßo
function confirmarAplicacaoPreco() {
    const dados = window.precoParaConfirmar;
    
    if (!dados) {
        alert('Erro: dados do pre√ßo n√£o encontrados.');
        return;
    }
    
    // Mostrar loading
    document.getElementById('btnConfirmarPreco').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...';
    document.getElementById('btnConfirmarPreco').disabled = true;
    
    // Preparar dados para envio
    const dadosEnvio = {
        servico_id: dados.servicoId,
        preco: dados.preco,
        tipo: dados.tipo,
        fonte: `${dados.servicoOrigem} - ${dados.veiculo}`
    };
    
    if (dados.grupoId) {
        dadosEnvio.grupo_id = dados.grupoId;
    }
    
    fetch('/escalas/api/atualizar-preco/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dadosEnvio)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fechar modal de confirma√ß√£o
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacaoPreco'));
            modal.hide();
            
            // Mostrar sucesso e recarregar
            mostrarNotificacaoSucesso(`Pre√ßo atualizado para R$ ${dados.preco.toFixed(2)}`);
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            alert('Erro ao atualizar pre√ßo: ' + data.error);
            // Restaurar bot√£o
            document.getElementById('btnConfirmarPreco').innerHTML = '<i class="fas fa-check"></i> Confirmar';
            document.getElementById('btnConfirmarPreco').disabled = false;
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        alert('Erro ao atualizar pre√ßo.');
        // Restaurar bot√£o
        document.getElementById('btnConfirmarPreco').innerHTML = '<i class="fas fa-check"></i> Confirmar';
        document.getElementById('btnConfirmarPreco').disabled = false;
    });
}

// Fun√ß√£o para mostrar notifica√ß√£o de sucesso
function mostrarNotificacaoSucesso(mensagem) {
    // Criar elemento de notifica√ß√£o
    const notificacao = document.createElement('div');
    notificacao.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notificacao.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notificacao.innerHTML = `
        <i class="fas fa-check-circle"></i> ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notificacao);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        if (notificacao.parentNode) {
            notificacao.remove();
        }
    }, 3000);
}

// Fun√ß√£o para aplicar pre√ßo customizado
function aplicarPrecoCustomizado() {
    const precoInput = document.getElementById('precoCustomizado');
    const preco = parseFloat(precoInput.value);
    
    if (isNaN(preco) || preco <= 0) {
        alert('Por favor, insira um pre√ßo v√°lido.');
        return;
    }
    
    const servicoId = document.getElementById('servicoIdSelecionado').value;
    const tipo = document.getElementById('tipoSelecionado').value;
    const grupoId = document.getElementById('grupoIdSelecionado').value;
    
    // Armazenar dados para confirma√ß√£o
    window.precoParaConfirmar = {
        preco: preco,
        servicoOrigem: 'Pre√ßo',
        veiculo: 'Customizado',
        servicoId: servicoId,
        tipo: tipo,
        grupoId: grupoId
    };
    
    // Preencher modal de confirma√ß√£o
    document.getElementById('precoConfirmacao').textContent = `R$ ${preco.toFixed(2)}`;
    document.getElementById('origemConfirmacao').textContent = 'Pre√ßo Customizado';
    
    // Fechar modal de tarif√°rios e abrir modal de confirma√ß√£o
    const modalTarifarios = bootstrap.Modal.getInstance(document.getElementById('modalTarifarios'));
    modalTarifarios.hide();
    
    const modalConfirmacao = new bootstrap.Modal(document.getElementById('modalConfirmacaoPreco'));
    modalConfirmacao.show();
}

// Funcionalidade de busca nas tabelas
document.addEventListener('DOMContentLoaded', function() {
    // Busca no tarif√°rio JW
    document.getElementById('buscaJW').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const linhas = document.querySelectorAll('#tabelaJW tr');
        
        linhas.forEach(linha => {
            const texto = linha.textContent.toLowerCase();
            linha.style.display = texto.includes(termo) ? '' : 'none';
        });
    });
    
    // Busca no tarif√°rio de motoristas
    document.getElementById('buscaMotoristas').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const linhas = document.querySelectorAll('#tabelaMotoristas tr');
        
        linhas.forEach(linha => {
            const texto = linha.textContent.toLowerCase();
            linha.style.display = texto.includes(termo) ? '' : 'none';
        });
    });
    
    // Verifica√ß√£o de elementos essenciais para tarif√°rios
    console.log('üöÄ Verificando elementos essenciais para funcionalidade de tarif√°rios...');
    
    const elementosEssenciais = [
        'modalConfirmacaoPreco',
        'precoConfirmacao', 
        'origemConfirmacao',
        'modalTarifarios'
    ];
    
    const elementosEncontrados = {};
    const elementosAusentes = [];
    
    elementosEssenciais.forEach(id => {
        const elemento = document.getElementById(id);
        elementosEncontrados[id] = elemento;
        if (!elemento) {
            elementosAusentes.push(id);
        }
    });
    
    console.log('‚úÖ Elementos encontrados:', elementosEncontrados);
    
    if (elementosAusentes.length > 0) {
        console.error('‚ùå Elementos ausentes:', elementosAusentes);
        console.log('üîç Total de elementos com ID no documento:', document.querySelectorAll('[id]').length);
        console.warn('‚ö†Ô∏è Funcionalidade de tarif√°rios pode n√£o funcionar corretamente!');
    } else {
        console.log('‚úÖ Todos os elementos essenciais para tarif√°rios encontrados!');
    }
});
</script>

<!-- Modal de Detalhes e Edi√ß√£o do Servi√ßo -->
<div class="modal fade" id="modalDetalhesServico" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesLabel">
                    <i class="fas fa-edit"></i> Detalhes e Edi√ß√£o do Servi√ßo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarServico">
                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="editCliente" class="form-label">
                                <i class="fas fa-user"></i> Cliente
                            </label>
                            <input type="text" class="form-control" id="editCliente" name="cliente">
                        </div>
                        <div class="col-md-4">
                            <label for="editPax" class="form-label">
                                <i class="fas fa-users"></i> PAX
                            </label>
                            <input type="number" class="form-control" id="editPax" name="pax" min="1">
                        </div>
                    </div>

                    <!-- Servi√ßo e Pickup -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editServico" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> Servi√ßo
                            </label>
                            <textarea class="form-control" id="editServico" name="servico" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editPickup" class="form-label">
                                <i class="fas fa-location-dot"></i> Local de Pickup
                            </label>
                            <input type="text" class="form-control" id="editPickup" name="local_pickup">
                        </div>
                    </div>

                    <!-- Hor√°rio e Data -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editHorario" class="form-label">
                                <i class="fas fa-clock"></i> Hor√°rio
                            </label>
                            <input type="time" class="form-control" id="editHorario" name="horario">
                        </div>
                        <div class="col-md-6">
                            <label for="editDataServico" class="form-label">
                                <i class="fas fa-calendar"></i> Data do Servi√ßo
                            </label>
                            <input type="date" class="form-control" id="editDataServico" name="data_do_servico">
                        </div>
                    </div>

                    <!-- Informa√ß√µes da Venda -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editNumeroVenda" class="form-label">
                                <i class="fas fa-hashtag"></i> N√∫mero da Venda
                            </label>
                            <input type="text" class="form-control" id="editNumeroVenda" name="numero_venda">
                        </div>
                    </div>

                    <!-- Caracter√≠sticas do Servi√ßo -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="editTipo" class="form-label">
                                <i class="fas fa-layer-group"></i> Tipo
                            </label>
                            <select class="form-control" id="editTipo" name="tipo">
                                <option value="TRANSFER">Transfer</option>
                                <option value="DISPOSICAO">Disposi√ß√£o</option>
                                <option value="TOUR">Tour</option>
                                <option value="OUTRO">Outro</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="editDirecao" class="form-label">
                                <i class="fas fa-arrows-alt-h"></i> Dire√ß√£o
                            </label>
                            <select class="form-control" id="editDirecao" name="direcao">
                                <option value="IN">IN</option>
                                <option value="OUT">OUT</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="editAeroporto" class="form-label">
                                <i class="fas fa-plane"></i> Aeroporto
                            </label>
                            <select class="form-control" id="editAeroporto" name="aeroporto">
                                <option value="GIG">GIG</option>
                                <option value="SDU">SDU</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="editRegiao" class="form-label">
                                <i class="fas fa-map"></i> Regi√£o
                            </label>
                            <select class="form-control" id="editRegiao" name="regiao">
                                <option value="ZONA SUL">Zona Sul</option>
                                <option value="SANTOS DUMONT">Santos Dumont</option>
                                <option value="BARRA">Barra</option>
                                <option value="CENTRO">Centro</option>
                                <option value="BUZIOS">B√∫zios</option>
                                <option value="ANGRA">Angra</option>
                                <option value="PETROPOLIS">Petr√≥polis</option>
                                <option value="PARATY">Paraty</option>
                                <option value="MACAE">Maca√©</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                    </div>

                    <!-- Caracter√≠sticas Especiais -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editEhRegular" name="eh_regular">
                                <label class="form-check-label" for="editEhRegular">
                                    <i class="fas fa-sync"></i> √â Regular
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editEhPrioritario" name="eh_prioritario">
                                <label class="form-check-label" for="editEhPrioritario">
                                    <i class="fas fa-star"></i> √â Priorit√°rio
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Van Atual -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editVan" class="form-label">
                                <i class="fas fa-van-shuttle"></i> Van Atual
                            </label>
                            <select class="form-control" id="editVan" name="van">
                                <option value="VAN1">Van 1</option>
                                <option value="VAN2">Van 2</option>
                            </select>
                        </div>
                    </div>

                    <!-- IDs ocultos -->
                    <input type="hidden" id="editServicoId" name="servico_id">
                    <input type="hidden" id="editAlocacaoId" name="alocacao_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnExcluirServico">
                    <i class="fas fa-trash"></i> Excluir Servi√ßo
                </button>
                <button type="button" class="btn btn-primary" id="btnSalvarEdicao">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Edi√ß√£o de Grupo -->
<div class="modal fade" id="modalDetalhesGrupo" tabindex="-1" aria-labelledby="modalGrupoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalGrupoLabel">
                    <i class="fas fa-layer-group"></i> Detalhes do Grupo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarGrupo">
                    <!-- Informa√ß√µes Gerais do Grupo -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="editGrupoCliente" class="form-label">
                                <i class="fas fa-user"></i> Cliente Principal
                            </label>
                            <input type="text" class="form-control" id="editGrupoCliente" name="cliente_principal">
                        </div>
                        <div class="col-md-4">
                            <label for="editGrupoTotalPax" class="form-label">
                                <i class="fas fa-users"></i> Total PAX
                            </label>
                            <input type="number" class="form-control" id="editGrupoTotalPax" name="total_pax" readonly>
                        </div>
                    </div>

                    <!-- Servi√ßo e Local Principal -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editGrupoServico" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> Servi√ßo Principal
                            </label>
                            <textarea class="form-control" id="editGrupoServico" name="servico_principal" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editGrupoPickup" class="form-label">
                                <i class="fas fa-location-dot"></i> Local de Pickup Principal
                            </label>
                            <input type="text" class="form-control" id="editGrupoPickup" name="local_pickup_principal">
                        </div>
                    </div>

                    <!-- Van do Grupo -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editGrupoVan" class="form-label">
                                <i class="fas fa-van-shuttle"></i> Van do Grupo
                            </label>
                            <select class="form-control" id="editGrupoVan" name="van">
                                <option value="VAN1">Van 1</option>
                                <option value="VAN2">Van 2</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editGrupoTotal" class="form-label">
                                <i class="fas fa-dollar-sign"></i> Valor Total
                            </label>
                            <input type="number" class="form-control" id="editGrupoTotal" name="total_valor" step="0.01" readonly>
                        </div>
                    </div>

                    <!-- Lista de Servi√ßos do Grupo -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-list"></i> Servi√ßos no Grupo
                        </label>
                        <div id="listaServicosGrupo" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>
                    </div>

                    <!-- IDs ocultos -->
                    <input type="hidden" id="editGrupoId" name="grupo_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnDesagruparTodos">
                    <i class="fas fa-unlink"></i> Desagrupar Todos
                </button>
                <button type="button" class="btn btn-primary" id="btnSalvarGrupo">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Tarif√°rios para Edi√ß√£o de Pre√ßos -->
<div class="modal fade" id="modalTarifarios" tabindex="-1" aria-labelledby="modalTarifariosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTarifariosLabel">
                    <i class="fas fa-dollar-sign"></i> Escolher Pre√ßo dos Tarif√°rios
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Navega√ß√£o por Abas -->
                <ul class="nav nav-tabs" id="tarifarioModalTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="jw-modal-tab" data-bs-toggle="tab" data-bs-target="#jw-modal" type="button" role="tab">
                            <i class="fas fa-bus"></i> Tarif√°rio JW
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="motoristas-modal-tab" data-bs-toggle="tab" data-bs-target="#motoristas-modal" type="button" role="tab">
                            <i class="fas fa-user-tie"></i> Tarif√°rio Motoristas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="customizado-modal-tab" data-bs-toggle="tab" data-bs-target="#customizado-modal" type="button" role="tab">
                            <i class="fas fa-edit"></i> Pre√ßo Customizado
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="tarifarioModalTabContent">
                    <!-- Tarif√°rio JW -->
                    <div class="tab-pane fade show active" id="jw-modal" role="tabpanel">
                        <div class="mt-3">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="buscaJW" placeholder="Buscar servi√ßo no tarif√°rio JW...">
                            </div>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Servi√ßo</th>
                                            <th>Executivo</th>
                                            <th>Van 15</th>
                                            <th>Van 18</th>
                                            <th>Micro</th>
                                            <th>√înibus</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaJW">
                                        <!-- Ser√° preenchido dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tarif√°rio Motoristas -->
                    <div class="tab-pane fade" id="motoristas-modal" role="tabpanel">
                        <div class="mt-3">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="buscaMotoristas" placeholder="Buscar servi√ßo no tarif√°rio de motoristas...">
                            </div>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Servi√ßo</th>
                                            <th>Pre√ßo Base</th>
                                            <th>Observa√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaMotoristas">
                                        <!-- Ser√° preenchido dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Pre√ßo Customizado -->
                    <div class="tab-pane fade" id="customizado-modal" role="tabpanel">
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="precoCustomizado" class="form-label">
                                        <i class="fas fa-dollar-sign"></i> Pre√ßo Personalizado
                                    </label>
                                    <input type="number" class="form-control" id="precoCustomizado" 
                                           placeholder="0.00" step="0.01" min="0">
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" class="btn btn-success" onclick="aplicarPrecoCustomizado()">
                                        <i class="fas fa-check"></i> Aplicar Pre√ßo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes Ocultas -->
                <input type="hidden" id="servicoIdSelecionado">
                <input type="hidden" id="tipoSelecionado">
                <input type="hidden" id="grupoIdSelecionado">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Aplica√ß√£o de Pre√ßo -->
<div class="modal fade" id="modalConfirmacaoPreco" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalConfirmacaoLabel">
                    <i class="fas fa-dollar-sign"></i> Confirmar Aplica√ß√£o de Pre√ßo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-question-circle text-primary" style="font-size: 3rem;"></i>
                </div>
                <h5>Aplicar o seguinte pre√ßo?</h5>
                <div class="alert alert-info mt-3">
                    <div class="row">
                        <div class="col-6">
                            <strong>Pre√ßo:</strong>
                        </div>
                        <div class="col-6">
                            <span class="badge bg-success fs-6" id="precoConfirmacao">R$ 0,00</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <strong>Origem:</strong>
                        </div>
                        <div class="col-6">
                            <span id="origemConfirmacao">-</span>
                        </div>
                    </div>
                </div>
                <p class="text-muted small">Esta a√ß√£o substituir√° o pre√ßo atual do servi√ßo.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarPreco" onclick="confirmarAplicacaoPreco()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
